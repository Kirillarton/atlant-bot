<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, user-scalable=no, viewport-fit=cover">
    <title>–°–∏–º—É–ª—è—Ç–æ—Ä –ë–æ—Ç–∞ ¬´–ê—Ç–ª–∞–Ω—Ç¬ª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .chat-bubble { max-width: 85%; word-wrap: break-word; }
        .chat-container::-webkit-scrollbar { width: 4px; }
        .chat-container::-webkit-scrollbar-thumb { background-color: #4A5568; border-radius: 20px; }
        .keyboard-grid button { transition: all 0.2s ease-in-out; }
        .keyboard-grid button:active { transform: scale(0.95); }
        .bonus-card {
            background-image: url('https://img.freepik.com/free-vector/abstract-plexus-background-with-connecting-dots-lines_1017-23348.jpg?w=1380&t=st=1719427845~exp=1719428445~hmac=e20f269a31a4c0a5d4e135b026615b3c3b53f6834b126ac002b4742e7428f522');
            background-size: cover;
            background-position: center;
            border: 1px solid #718096;
            position: relative;
        }
        .bonus-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(45, 55, 72, 0.7); border-radius: 0.75rem; }
        .bonus-card > * { position: relative; z-index: 10; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-2 md:p-4">

<div id="app-container" class="w-full max-w-lg bg-gray-800 rounded-2xl shadow-2xl flex flex-col h-[95vh] md:h-[90vh]" style="display: none;">
    <div class="p-4 border-b border-gray-700 flex items-center space-x-4 flex-shrink-0">
        <div class="relative">
            <img id="bot-avatar" class="w-12 h-12 rounded-full" src="https://placehold.co/100x100/1a202c/ffffff?text=M" alt="–ê–≤–∞—Ç–∞—Ä –ë–æ—Ç–∞">
            <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-gray-800 rounded-full"></span>
        </div>
        <div>
            <h1 id="bot-name" class="text-xl font-bold">–ê—Ç–ª–∞–Ω—Ç –ë–æ—Ç</h1>
            <p class="text-sm text-green-400">–≤ —Å–µ—Ç–∏</p>
        </div>
    </div>

    <div id="chat-container" class="flex-1 p-4 space-y-4 overflow-y-auto chat-container"></div>

    <div id="keyboard-area" class="p-3 bg-gray-900/50 border-t border-gray-700 flex-shrink-0"></div>
</div>

<div id="loading-screen" class="flex flex-col items-center justify-center">
    <div class="loader"></div>
    <p class="mt-4 text-lg">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

    // --- –í–ê–®–ê –ü–ï–†–°–û–ù–ê–õ–¨–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDFWm4OyjHgAsgVTMkhApeGaAZC5CSXEi8",
        authDomain: "atlant-bot-1d0d5.firebaseapp.com",
        projectId: "atlant-bot-1d0d5",
        storageBucket: "atlant-bot-1d0d5.firebasestorage.app",
        messagingSenderId: "1002159529192",
        appId: "1:1002159529192:web:cac088727395f079e9fd5d",
        measurementId: "G-29FH6CDF19"
    };

    // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è Firebase –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã ---
    let db, auth, userId;
    const appContainer = document.getElementById('app-container');
    const loadingScreen = document.getElementById('loading-screen');
    const appId = 53820374; // <-- –≠—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ appId –∫–∞–∫ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã


    // --- –ó–ê–ì–õ–£–®–ö–ê VK BRIDGE –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø –í –ë–†–ê–£–ó–ï–†–ï ---
    if (typeof vkBridge === 'undefined') {
        console.warn('VK Bridge –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–æ–∫-–æ–±—ä–µ–∫—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.');
        window.vkBridge = {
            send: (method, params) => {
                console.log('–í—ã–∑–æ–≤ –º–æ–∫-–æ–±—ä–µ–∫—Ç–∞ VK Bridge:', method, params);
                return new Promise((resolve, reject) => {
                    switch (method) {
                        case 'VKWebAppInit':
                            resolve({ result: true });
                            break;
                        case 'VKWebAppGetUserInfo':
                            resolve({ id: 1, first_name: '–ü–∞–≤–µ–ª', last_name: '–î—É—Ä–æ–≤', photo_100: 'https://placehold.co/100x100/7f9aed/ffffff?text=VK' });
                            break;
                        case 'VKWebAppOpenPayForm':
                            // –ò–º–∏—Ç–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –æ–ø–ª–∞—Ç—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                            alert(`–ú–æ–∫-–æ–ø–ª–∞—Ç–∞ –∑–∞: ${params.params.item}. –¶–µ–Ω–∞: ${params.params.price} –≥–æ–ª–æ—Å–æ–≤.`);
                            resolve({ status: 'success', transaction_id: 'MOCK_TRANSACTION_123' });
                            break;
                        default:
                            resolve({ result: true });
                    }
                });
            }
        };
    }

    // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò–ì–†–´ ---
    const config = {
        workContracts: [
            { id: 1, title: "–î–æ—Å—Ç–∞–≤–∫–∞ –ø–∏—Ü—Ü—ã", duration: 60, minReward: 5000, maxReward: 10000, risk: 0.1, requiredLevel: 1 },
            { id: 2, title: "–ü–µ—Ä–µ–≤–æ–∑–∫–∞ –º–µ–±–µ–ª–∏", duration: 180, minReward: 30000, maxReward: 50000, risk: 0.2, requiredLevel: 5 },
            { id: 3, title: "–ö–æ–Ω—Ç—Ä–∞–±–∞–Ω–¥–∞ —á–∏–ø–æ–≤", duration: 300, minReward: 100000, maxReward: 250000, risk: 0.4, requiredLevel: 10 },
        ],
        cases: {
            'basic_case': { id: 'basic_case', name: "–ë–∞–∑–æ–≤—ã–π –∫–µ–π—Å", icon: "üì¶", possibleLoot: [50000, 100000, 200000, 300000, 500000] },
            'pro_case': { id: 'pro_case', name: "–ü—Ä–æ-–∫–µ–π—Å", icon: "üíº", possibleLoot: [100000, 200000, 350000, 500000, 750000] },
            'elite_case': { id: 'elite_case', name: "–≠–ª–∏—Ç–Ω—ã–π –∫–µ–π—Å", icon: "üëë", possibleLoot: [150000, 300000, 450000, 600000, 750000] },
            'ultra_case': { id: 'ultra_case', name: "–£–ª—å—Ç—Ä–∞ –∫–µ–π—Å", icon: "üíé", possibleLoot: [250000, 500000, 750000, 1000000, 1500000] }
        },
        // --- –ù–û–í–´–ï –î–û–ù–ê–¢ –ö–ï–ô–°–´ ---
        donationCases: {
            'starter_pack': { id: 'starter_pack', name: '–ù–∞–±–æ—Ä –ù–æ–≤–∏—á–∫–∞', icon: 'üöÄ', price: 10, content: { balance: 500000, items: [{id: 'basic_case', quantity: 5, type: 'case', name: '–ë–∞–∑–æ–≤—ã–π –∫–µ–π—Å', icon: 'üì¶'}] } },
            'tycoon_case': { id: 'tycoon_case', name: '–ö–µ–π—Å –ë–∏–∑–Ω–µ—Å–º–µ–Ω–∞', icon: 'üé©', price: 50, content: { balance: 2500000, items: [{id: 'pro_case', quantity: 3, type: 'case', name: '–ü—Ä–æ-–∫–µ–π—Å', icon: 'üíº'}, {id: 'elite_case', quantity: 1, type: 'case', name: '–≠–ª–∏—Ç–Ω—ã–π –∫–µ–π—Å', icon: 'üëë'}] } },
            'investor_bundle': { id: 'investor_bundle', name: '–ù–∞–±–æ—Ä –ò–Ω–≤–µ—Å—Ç–æ—Ä–∞', icon: 'üìà', price: 100, content: { bitcoin: 50, euro: 100, items: [{id: 'ultra_case', quantity: 2, type: 'case', name: '–£–ª—å—Ç—Ä–∞ –∫–µ–π—Å', icon: 'üíé'}] } }
        },
        businessesForSale: [
            { id: 12, name: "–ö–∏—Ç–∞–π—Å–∫–∏–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω", price: 35000000, profit: 154000 },
            { id: 15, name: "–®–∞—É—Ä–º–∏—á–Ω–∞—è", price: 5000000, profit: 25000 },
            { id: 18, name: "–ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å", price: 50000000, profit: 250000 },
        ]
    };

    // --- –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ ---
    let gameState = {};

    // --- –≠–õ–ï–ú–ï–ù–¢–´ –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
    const chatContainer = document.getElementById('chat-container');
    const keyboardArea = document.getElementById('keyboard-area');

    // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
    function formatCurrency(n, c = '$') { return `üí∞ ${new Intl.NumberFormat('ru-RU').format(Math.round(n))}${c}`; }
    function formatBTC(n) { return `üíé ${(n || 0).toFixed(4)}‚Çø`; }
    function formatEuro(n) { return `üí∂ ${new Intl.NumberFormat('ru-RU').format(Math.round(n))}‚Ç¨`; }
    function formatTime(ms) { if (ms <= 0) return "0 —Å–µ–∫."; let s = Math.floor((ms / 1000) % 60), m = Math.floor((ms / 60000) % 60), h = Math.floor(ms / 3600000); return `${h} —á. ${m} –º–∏–Ω. ${s} —Å–µ–∫.`; }
    function formatFullDate(d) { return new Date(d).toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }
    function getDaysInGame(joinTimestamp) { return Math.floor((Date.now() - joinTimestamp) / 86400000); }
    function getXpForNextLevel(l) { return 4 + (4 * l); }
    function parseAmount(str) { let s = String(str).toLowerCase().trim().replace(/–∫/g, 'k'); let value = parseFloat(s.replace(/,/g, '')); if (s.endsWith('kk')) { value *= 1000000; } else if (s.endsWith('k')) { value *= 1000; } return isNaN(value) ? 0 : value; }

    // --- –°–û–•–†–ê–ù–ï–ù–ò–ï –î–ê–ù–ù–´–• –í FIRESTORE ---
    async function savePlayerState() {
        if (!db || !userId) return;
        try {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç player –≤ JSON-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç
            const stateToSave = JSON.parse(JSON.stringify(gameState.player));
            const playerDocRef = doc(db, `/artifacts/${appId}/users/${userId}/gameData/player`);
            await setDoc(playerDocRef, stateToSave);
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞: ", error);
            addBotMessage('<p class="text-red-400">‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>');
        }
    }

    // --- –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ì–†–´ (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º) ---
    function addBotMessage(text, asHtml = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex justify-start items-start space-x-2';
        messageDiv.innerHTML = `
            <img class="w-8 h-8 rounded-full flex-shrink-0" src="https://placehold.co/100x100/1a202c/ffffff?text=B" alt="–ê–≤–∞—Ç–∞—Ä –ë–æ—Ç–∞">
            <div class="bg-gray-700 text-white p-3 rounded-xl rounded-tl-none chat-bubble">
                ${asHtml ? text : `<p>${text}</p>`}
            </div>
        `;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function addUserMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex justify-end items-start space-x-2';
        messageDiv.innerHTML = `
            <div class="bg-blue-600 text-white p-3 rounded-xl rounded-tr-none chat-bubble">
                <p>${text}</p>
            </div>
            <img class="w-8 h-8 rounded-full flex-shrink-0" src="${document.getElementById('bot-avatar').src}" alt="–ê–≤–∞—Ç–∞—Ä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        `;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function renderKeyboard(buttons = []) {
        keyboardArea.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        const gridDiv = document.createElement('div');
        gridDiv.className = 'keyboard-grid grid grid-cols-2 gap-2';

        if (buttons.length === 0) { // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            switch (gameState.currentMenu) {
                case 'main':
                    buttons = [
                        { label: '‚öôÔ∏è –ü—Ä–æ—Ñ–∏–ª—å', command: 'view_profile' },
                        { label: 'üíº –†–∞–±–æ—Ç–∞', command: 'view_work' },
                        { label: 'üè¶ –ë–∞–Ω–∫', command: 'view_bank' },
                        { label: 'üìà –†—ã–Ω–æ–∫', command: 'view_market' },
                        { label: 'üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω', command: 'view_shop' }, // –î–æ–±–∞–≤–ª–µ–Ω–æ: –∫–Ω–æ–ø–∫–∞ "–ú–∞–≥–∞–∑–∏–Ω"
                        { label: 'üéÅ –ë–æ–Ω—É—Å—ã', command: 'get_bonus' }
                    ];
                    break;
                case 'profile':
                    buttons = [
                        { label: 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', command: 'profile_stats' },
                        { label: '‚¨ÜÔ∏è –£—Ä–æ–≤–Ω–∏', command: 'profile_levels' },
                        { label: 'üè¢ –ë–∏–∑–Ω–µ—Å—ã', command: 'profile_businesses' },
                        { label: 'üì¶ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å', command: 'profile_inventory' },
                        { label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back' }
                    ];
                    break;
                case 'work':
                    buttons = [
                        { label: '–î–æ—Å—Ç–∞–≤–∫–∞ –ø–∏—Ü—Ü—ã (1-5–∫)', command: 'work_start 1' },
                        { label: '–ü–µ—Ä–µ–≤–æ–∑–∫–∞ –º–µ–±–µ–ª–∏ (30-50–∫)', command: 'work_start 2' },
                        { label: '–ö–æ–Ω—Ç—Ä–∞–±–∞–Ω–¥–∞ —á–∏–ø–æ–≤ (100-250–∫)', command: 'work_start 3' },
                        { label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back' }
                    ];
                    break;
                case 'bank':
                    buttons = [
                        { label: '‚õèÔ∏è –ú–∞–π–Ω–∏–Ω–≥', command: 'view_mining' },
                        { label: 'üí∞ –í–∫–ª–∞–¥—ã', command: 'view_deposits' },
                        { label: 'üë¥ –ü–µ–Ω—Å–∏—è', command: 'bank_pension' },
                        { label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back' }
                    ];
                    break;
                case 'mining':
                    const miningActive = gameState.player.mining && gameState.player.mining.active;
                    buttons = [
                        miningActive ? { label: 'üíé –ó–∞–±—Ä–∞—Ç—å BTC', command: 'mining_claim' } : { label: '‚õèÔ∏è –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ú–∞–π–Ω–∏–Ω–≥', command: 'mining_activate' },
                        { label: '‚¨ÜÔ∏è –£–ª—É—á—à–∏—Ç—å –ú–∞–π–Ω–µ—Ä', command: 'mining_upgrade_prompt' },
                        { label: 'üí≤ –ü—Ä–æ–¥–∞—Ç—å BTC', command: 'mining_sell_prompt' },
                        { label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back' }
                    ];
                    break;
                case 'deposits':
                    buttons = [
                        { label: '‚ûï –û—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥', command: 'deposit_create_prompt' },
                        { label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back' }
                    ];
                    break;
                case 'market':
                    buttons = [
                        { label: 'üè¢ –ö—É–ø–∏—Ç—å –±–∏–∑–Ω–µ—Å', command: 'market_businesses' },
                        { label: 'üéÅ –ü—Ä–æ–º–æ–∫–æ–¥—ã', command: 'view_promo' },
                        { label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back' }
                    ];
                    break;
                case 'promo':
                    buttons = [
                        { label: '‚ûï –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥', command: 'promo_create_prompt' },
                        { label: 'üéÅ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥', command: 'promo_activate_prompt' },
                        { label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back' }
                    ];
                    break;
                case 'inventory':
                    buttons = [];
                    if (gameState.player.inventory && gameState.player.inventory.length > 0) {
                        gameState.player.inventory.forEach(item => {
                            if (item.type === 'case') {
                                buttons.push({ label: `${item.icon} ${item.name} (${item.quantity})`, command: `item_manage ${item.id}` });
                            }
                        });
                    }
                    buttons.push({ label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back' });
                    break;
                case 'item_management': // –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–æ–º
                    buttons = [
                        { label: '‚ûï –û—Ç–∫—Ä—ã—Ç—å 1', command: `case_open ${gameState.currentManagedItemId} 1` },
                        { label: '‚ûï –û—Ç–∫—Ä—ã—Ç—å 5', command: `case_open ${gameState.currentManagedItemId} 5` },
                        { label: '‚ûï –û—Ç–∫—Ä—ã—Ç—å 10', command: `case_open ${gameState.currentManagedItemId} 10` },
                        { label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'view_inventory' }
                    ];
                    break;
                case 'shop': // –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞
                    for (const key in config.donationCases) {
                        const item = config.donationCases[key];
                        buttons.push({ label: `–ö—É–ø–∏—Ç—å ${item.name} (${item.price} –≥–æ–ª.)`, command: `shop_buy ${item.id}` });
                    }
                    buttons.push({ label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back' });
                    break;
                case 'input': // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤–≤–æ–¥–∞
                    // –ó–¥–µ—Å—å –º—ã –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–º –∫–Ω–æ–ø–∫–∏, —Ç–∞–∫ –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç—Å—è –≤–≤–æ–¥
                    break;
            }
        }

        buttons.forEach(btn => {
            const button = document.createElement('button');
            button.className = 'bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-xl text-lg transition duration-200 ease-in-out';
            button.textContent = btn.label;
            button.onclick = () => window.sendCommand(btn.command, btn.label, true); // –ü–µ—Ä–µ–¥–∞–µ–º label –∏ isNavCommand
            gridDiv.appendChild(button);
        });

        keyboardArea.appendChild(gridDiv);

        // –ï—Å–ª–∏ –æ–∂–∏–¥–∞–µ—Ç—Å—è –≤–≤–æ–¥, –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
        if (gameState.prompt) {
            const inputGroup = document.createElement('div');
            inputGroup.className = 'mt-3 flex space-x-2';
            inputGroup.innerHTML = `
                <input type="text" id="text-input" placeholder="${gameState.prompt.placeholder || '–í–≤–µ–¥–∏—Ç–µ —á—Ç–æ-—Ç–æ...'}"
                       class="flex-1 bg-gray-700 text-white p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                       onkeydown="if(event.keyCode===13) window.submitInput()">
                <button onclick="window.submitInput()"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 ease-in-out">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            `;
            keyboardArea.appendChild(inputGroup);
            document.getElementById('text-input').focus();
        }
    }

    function renderInput(placeholder, prevView = null) {
        gameState.prompt = { placeholder, prevView };
        renderKeyboard([]); // –†–µ–Ω–¥–µ—Ä–∏–º –ø—É—Å—Ç—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–Ω–ø—É—Ç
    }

    function showView(viewName) {
        if (gameState.currentMenu !== viewName && !['input', 'prompt'].includes(viewName)) {
            gameState.menuHistory.push(gameState.currentMenu);
        }
        gameState.currentMenu = viewName;
        renderKeyboard();
    }

    function goBack() {
        if (gameState.menuHistory.length > 0) {
            const prevMenu = gameState.menuHistory.pop();
            gameState.currentMenu = prevMenu;
            renderKeyboard();
        } else {
            showView('main'); // –ï—Å–ª–∏ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        }
    }

    function backToMain() {
        gameState.menuHistory = []; // –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        showView('main');
    }

    // ... (–≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–¥–∞, –Ω–æ —Å –≤—ã–∑–æ–≤–æ–º savePlayerState() –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è gameState.player)
    // –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —è –Ω–µ –±—É–¥—É –ø–æ–≤—Ç–æ—Ä—è—Ç—å —Ü–µ–ª–∏–∫–æ–º, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –±—ã–ª–∏ –≤ –≤–∞—à–µ–º –∫–æ–¥–µ –∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã.
    // –ü—Ä–æ—Å—Ç–æ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω–∏ –≤—ã–∑—ã–≤–∞—é—Ç savePlayerState() –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ gameState.player.

    // –ü–µ—Ä–µ–¥–µ–ª–∞–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–∫–∞–∫ –≤ –≤–∞—à–µ–º –∫–æ–¥–µ)
    // addBotMessage, addUserMessage, renderKeyboard, renderInput, showView, goBack, backToMain - —è –≤–∫–ª—é—á–∏–ª –∏—Ö –ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

    // –§—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑—ã–≤–∞—é—Ç savePlayerState:
    // createPromoExecute, activatePromoPrompt, openCase, initiatePayment

    async function startWork(contractId) {
        const contract = config.workContracts.find(c => c.id === contractId);
        if (!contract) { addBotMessage("<p>–¢–∞–∫–æ–π —Ä–∞–±–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>"); return; }
        const p = gameState.player;
        if (p.level < contract.requiredLevel) { addBotMessage(`<p>‚ùå –î–ª—è —ç—Ç–æ–π —Ä–∞–±–æ—Ç—ã –Ω—É–∂–µ–Ω —É—Ä–æ–≤–µ–Ω—å ${contract.requiredLevel}. –£ –≤–∞—Å ${p.level}.</p>`); return; }
        if (p.currentWork && p.currentWork.endTime > Date.now()) { addBotMessage("<p>‚ö†Ô∏è –í—ã —É–∂–µ –Ω–∞ —Ä–∞–±–æ—Ç–µ! –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.</p>"); return; }

        p.currentWork = {
            contractId: contract.id,
            startTime: Date.now(),
            endTime: Date.now() + contract.duration * 1000 // Convert seconds to milliseconds
        };
        addBotMessage(`<p>‚úÖ –í—ã –ø—Ä–∏—Å—Ç—É–ø–∏–ª–∏ –∫ —Ä–∞–±–æ—Ç–µ "${contract.title}". –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${formatTime(contract.duration * 1000)}.</p>`);
        await savePlayerState();
        showView('work');
    }

    // –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, setInterval)
    async function gameTick() {
        const p = gameState.player;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã
        if (p.currentWork && p.currentWork.endTime <= Date.now()) {
            const contract = config.workContracts.find(c => c.id === p.currentWork.contractId);
            if (contract) {
                let reward = Math.floor(Math.random() * (contract.maxReward - contract.minReward + 1)) + contract.minReward;
                const riskFactor = Math.random();
                let message = `<p>‚úÖ –†–∞–±–æ—Ç–∞ "${contract.title}" –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ ${formatCurrency(reward)}.</p>`;

                if (riskFactor < contract.risk) {
                    reward = Math.floor(reward * 0.5); // –£–º–µ–Ω—å—à–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É –≤ —Å–ª—É—á–∞–µ —Ä–∏—Å–∫–∞
                    message = `<p class="text-yellow-400">‚ö†Ô∏è –†–∞–±–æ—Ç–∞ "${contract.title}" –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è–º–∏. –í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ ${formatCurrency(reward)} (–æ–±—ã—á–Ω–æ –±–æ–ª—å—à–µ).</p>`;
                }
                p.balance += reward;
                p.xp += 2; // –û–ø—ã—Ç –∑–∞ —Ä–∞–±–æ—Ç—É
                addBotMessage(message);
                checkLevelUp();
            }
            p.currentWork = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Ä–∞–±–æ—Ç—É
            await savePlayerState();
            showView('work'); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–π–Ω–∏–Ω–≥–∞
        if (p.mining && p.mining.active && p.mining.lastMined + p.mining.interval <= Date.now()) {
            p.bitcoin += p.mining.speed;
            p.mining.lastMined = Date.now();
            await savePlayerState();
            // addBotMessage(`<p>‚õèÔ∏è –í–∞—à –º–∞–π–Ω–µ—Ä –Ω–∞–º–∞–π–Ω–∏–ª ${formatBTC(p.mining.speed)}!</p>`);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∫–ª–∞–¥–æ–≤
        p.deposits.forEach(async (deposit, index) => {
            if (!deposit.claimed && deposit.payoutTime <= Date.now()) {
                const interest = deposit.amount * (deposit.rate / 100);
                const totalReturn = deposit.amount + interest;
                p.balance += totalReturn;
                deposit.claimed = true; // –û—Ç–º–µ—á–∞–µ–º –≤–∫–ª–∞–¥ –∫–∞–∫ –∑–∞–±—Ä–∞–Ω–Ω—ã–π
                addBotMessage(`<p>üè¶ –í–∞—à –≤–∫–ª–∞–¥ –Ω–∞ ${formatCurrency(deposit.amount)} —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω! –í—ã –ø–æ–ª—É—á–∏–ª–∏ ${formatCurrency(totalReturn)} (—á–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å ${formatCurrency(interest)}).</p>`);
                await savePlayerState();
            }
        });
        p.deposits = p.deposits.filter(d => !d.claimed); // –£–¥–∞–ª—è–µ–º –∑–∞–±—Ä–∞–Ω–Ω—ã–µ –≤–∫–ª–∞–¥—ã

        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π (–Ω–∞–ø—Ä., –±–∏–∑–Ω–µ—Å—ã)
    }

    function checkLevelUp() {
        const p = gameState.player;
        const xpForNext = getXpForNextLevel(p.level);
        if (p.xp >= xpForNext) {
            p.level++;
            p.xp -= xpForNext; // –û—Å—Ç–∞–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫ –æ–ø—ã—Ç–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
            p.balance += 100000 * p.level; // –ë–æ–Ω—É—Å –∑–∞ —É—Ä–æ–≤–µ–Ω—å
            p.businessSlots++; // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–ª–æ—Ç –±–∏–∑–Ω–µ—Å–∞
            addBotMessage(`<p class="text-green-400">üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ —É—Ä–æ–≤–Ω—è ${p.level}! –í—ã –ø–æ–ª—É—á–∏–ª–∏ ${formatCurrency(100000 * p.level)} –∏ –Ω–æ–≤—ã–π —Å–ª–æ—Ç –¥–ª—è –±–∏–∑–Ω–µ—Å–∞!</p>`);
            // –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ–ø—ã—Ç–∞ —Ö–≤–∞—Ç–∏–ª–æ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Ä–æ–≤–Ω–µ–π
            checkLevelUp();
        }
    }

    function showInitialProfile() {
        const p = gameState.player;
        const daysInGame = getDaysInGame(p.joinDate);
        addBotMessage(`
            <p><b>${p.name}, –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å:</b></p>
            <hr class="border-gray-600 my-1">
            <p>üí∞ –ë–∞–ª–∞–Ω—Å: ${formatCurrency(p.balance)}</p>
            <p>üíé Bitcoin: ${formatBTC(p.bitcoin)}</p>
            <p>üí∂ –ï–≤—Ä–æ: ${formatEuro(p.euro)}</p>
            <p>‚≠ê –£—Ä–æ–≤–µ–Ω—å: ${p.level} (–û–ø—ã—Ç: ${p.xp}/${getXpForNextLevel(p.level)})</p>
            <p>üíº –ë–∏–∑–Ω–µ—Å—ã: ${p.businesses.length}/${p.businessSlots}</p>
            <p>üìÖ –î–Ω–µ–π –≤ –∏–≥—Ä–µ: ${daysInGame}</p>
        `, true);
        showView('profile');
    }

    function showLevels() {
        const p = gameState.player;
        let msg = `<p><b>‚≠ê –í–∞—à–∞ –ø—Ä–æ–∫–∞—á–∫–∞:</b></p><hr class="border-gray-600 my-1">
                   <p>–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å: ${p.level}</p>
                   <p>–û–ø—ã—Ç: ${p.xp}/${getXpForNextLevel(p.level)}</p>
                   <p>–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å: ${p.level + 1}</p>`;
        addBotMessage(msg, true);
        showView('profile');
    }

    function showBusinesses() {
        const p = gameState.player;
        let msg = `<p><b>üè¢ –í–∞—à–∏ –±–∏–∑–Ω–µ—Å—ã (${p.businesses.length}/${p.businessSlots}):</b></p><hr class="border-gray-600 my-1">`;
        if (p.businesses.length === 0) {
            msg += "<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –±–∏–∑–Ω–µ—Å–æ–≤.</p>";
        } else {
            p.businesses.forEach(b => {
                msg += `<p>- ${b.name} (–ü—Ä–∏–±—ã–ª—å: ${formatCurrency(b.profit)}/—á.)</p>`;
            });
        }
        addBotMessage(msg, true);
        showView('profile');
    }

    function showMarketBusinesses() {
        let msg = '<p><b>üìà –ë–∏–∑–Ω–µ—Å—ã –Ω–∞ –ø—Ä–æ–¥–∞–∂—É:</b></p><hr class="border-gray-600 my-1">';
        const buttons = [];
        config.businessesForSale.forEach(b => {
            msg += `<p>üè¢ ${b.name}<br>–¶–µ–Ω–∞: ${formatCurrency(b.price)}<br>–ü—Ä–∏–±—ã–ª—å: ${formatCurrency(b.profit)}/—á.</p><hr class="border-gray-600 my-1">`;
            buttons.push({ label: `–ö—É–ø–∏—Ç—å "${b.name}"`, command: `biz_buy ${b.id}` });
        });
        buttons.push({ label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back' });
        addBotMessage(msg, true);
        renderKeyboard(buttons);
    }

    async function buyBusiness(businessId) {
        const business = config.businessesForSale.find(b => b.id === businessId);
        if (!business) { addBotMessage("<p>‚ùå –¢–∞–∫–æ–π –±–∏–∑–Ω–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>"); return; }
        const p = gameState.player;

        if (p.businesses.length >= p.businessSlots) {
            addBotMessage("<p>‚ùå –£ –≤–∞—Å –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞. –ü–æ–≤—ã—Å—å—Ç–µ —É—Ä–æ–≤–µ–Ω—å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –±–æ–ª—å—à–µ —Å–ª–æ—Ç–æ–≤.</p>");
            return;
        }
        if (p.balance < business.price) {
            addBotMessage("<p>‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ —ç—Ç–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞.</p>");
            return;
        }

        p.balance -= business.price;
        p.businesses.push(business);
        addBotMessage(`<p>‚úÖ –í—ã –∫—É–ø–∏–ª–∏ –±–∏–∑–Ω–µ—Å "${business.name}" –∑–∞ ${formatCurrency(business.price)}!</p>`);
        await savePlayerState();
        showView('market');
    }

    function activateMining() {
        const p = gameState.player;
        if (p.mining && p.mining.active) { addBotMessage("<p>‚õèÔ∏è –ú–∞–π–Ω–∏–Ω–≥ —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω!</p>"); return; }

        p.mining = {
            active: true,
            lastMined: Date.now(),
            level: 1,
            speed: 0.0001, // –Ω–∞—á–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –¥–æ–±—ã—á–∏ BTC
            interval: 3600 * 1000 // 1 —á–∞—Å –≤ –º—Å
        };
        addBotMessage("<p>‚úÖ –ú–∞–π–Ω–∏–Ω–≥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –í–∞—à –º–∞–π–Ω–µ—Ä —É–∂–µ –¥–æ–±—ã–≤–∞–µ—Ç Bitcoin.</p>");
        showView('mining');
    }

    function upgradeMiningPrompt() {
        const p = gameState.player;
        const cost = 500000 * p.mining.level; // –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
        addBotMessage(`<p>‚öôÔ∏è –£–ª—É—á—à–µ–Ω–∏–µ –º–∞–π–Ω–µ—Ä–∞ –¥–æ —É—Ä–æ–≤–Ω—è ${p.mining.level + 1} —Å—Ç–æ–∏—Ç ${formatCurrency(cost)}. –£–≤–µ–ª–∏—á–∏—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –¥–æ–±—ã—á–∏ BTC.</p>`, true);
        renderKeyboard([
            { label: `‚¨ÜÔ∏è –£–ª—É—á—à–∏—Ç—å (${formatCurrency(cost)})`, command: `mining_upgrade_execute` },
            { label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back' }
        ]);
        showView('mining_upgrade'); // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    }

    async function upgradeMiningExecute() {
        const p = gameState.player;
        const cost = 500000 * p.mining.level;
        if (p.balance < cost) {
            addBotMessage("<p>‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –º–∞–π–Ω–µ—Ä–∞.</p>");
            showView('mining');
            return;
        }

        p.balance -= cost;
        p.mining.level++;
        p.mining.speed += 0.0001; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å
        addBotMessage(`<p>‚úÖ –ú–∞–π–Ω–µ—Ä —É–ª—É—á—à–µ–Ω –¥–æ —É—Ä–æ–≤–Ω—è ${p.mining.level}! –°–∫–æ—Ä–æ—Å—Ç—å –¥–æ–±—ã—á–∏ —É–≤–µ–ª–∏—á–∏–ª–∞—Å—å.</p>`);
        await savePlayerState();
        showView('mining');
    }

    function claimMinedBtc() {
        const p = gameState.player;
        if (!p.mining || !p.mining.active) { addBotMessage("<p>‚õèÔ∏è –ú–∞–π–Ω–µ—Ä –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω.</p>"); return; }
        // Bitcoin –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ gameTick, –∑–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º
        addBotMessage(`<p>‚úÖ –í—ã —Å–æ–±—Ä–∞–ª–∏ –Ω–∞–º–∞–π–Ω–µ–Ω–Ω—ã–µ Bitcoin. –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: ${formatBTC(p.bitcoin)}</p>`);
        showView('mining');
    }

    function sellBtcPrompt() {
        addBotMessage("<p>üí≤ –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ Bitcoin, –∫–æ—Ç–æ—Ä–æ–µ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–∞—Ç—å. –¢–µ–∫—É—â–∏–π –∫—É—Ä—Å: 1 BTC = 50.000.000$ (—Ñ–∏–∫—Ç–∏–≤–Ω–æ).<br>–í–∞—à Bitcoin: " + formatBTC(gameState.player.bitcoin) + "</p>");
        renderInput("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ BTC...", 'view_mining');
        gameState.prompt = { callback: async (amountStr) => {
                const amount = parseFloat(amountStr.replace(',', '.'));
                if (isNaN(amount) || amount <= 0) {
                    addBotMessage("<p>‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.</p>");
                    showView('mining');
                    return;
                }
                const p = gameState.player;
                if (p.bitcoin < amount) {
                    addBotMessage("<p>‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Bitcoin.</p>");
                    showView('mining');
                    return;
                }
                const rate = 50000000; // –§–∏–∫—Ç–∏–≤–Ω—ã–π –∫—É—Ä—Å
                const earnings = amount * rate;
                p.bitcoin -= amount;
                p.balance += earnings;
                addBotMessage(`<p>‚úÖ –í—ã –ø—Ä–æ–¥–∞–ª–∏ ${formatBTC(amount)} –∏ –ø–æ–ª—É—á–∏–ª–∏ ${formatCurrency(earnings)}!</p>`);
                await savePlayerState();
                showView('mining');
            }};
    }

    function claimPension() {
        const p = gameState.player;
        const daysInGame = getDaysInGame(p.joinDate);
        if (daysInGame < 30) {
            addBotMessage(`<p>üë¥ –ü–µ–Ω—Å–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ 30 –¥–Ω–µ–π –≤ –∏–≥—Ä–µ. –í–∞–º –æ—Å—Ç–∞–ª–æ—Å—å ${30 - daysInGame} –¥–Ω–µ–π.</p>`);
            return;
        }
        const today = new Date().setHours(0,0,0,0);
        if (p.pension.lastClaimed && new Date(p.pension.lastClaimed).setHours(0,0,0,0) === today) {
            addBotMessage("<p>‚ùå –í—ã —É–∂–µ –ø–æ–ª—É—á–∏–ª–∏ –ø–µ–Ω—Å–∏—é —Å–µ–≥–æ–¥–Ω—è.</p>");
            return;
        }

        const pensionAmount = 10000 * daysInGame; // –ü—Ä–∏–º–µ—Ä: 10–∫ –∑–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
        p.balance += pensionAmount;
        p.pension.lastClaimed = Date.now();
        addBotMessage(`<p>‚úÖ –í—ã –ø–æ–ª—É—á–∏–ª–∏ –ø–µ–Ω—Å–∏—é: ${formatCurrency(pensionAmount)}!</p>`);
        showView('bank');
    }

    function claimBonus() {
        const p = gameState.player;
        const now = Date.now();
        const today = new Date().setHours(0, 0, 0, 0); // –ù–∞—á–∞–ª–æ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
        const yesterday = new Date(now - 86400000).setHours(0, 0, 0, 0); // –ù–∞—á–∞–ª–æ –≤—á–µ—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è

        // –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –±–æ–Ω—É—Å –±—ã–ª —Å–µ–≥–æ–¥–Ω—è
        if (p.bonus.lastClaimed && new Date(p.bonus.lastClaimed).setHours(0,0,0,0) === today) {
            addBotMessage("<p>‚ùå –í—ã —É–∂–µ –ø–æ–ª—É—á–∏–ª–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å —Å–µ–≥–æ–¥–Ω—è. –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –∑–∞–≤—Ç—Ä–∞!</p>");
            return;
        }

        let bonusAmount = 10000; // –ë–∞–∑–æ–≤—ã–π –±–æ–Ω—É—Å
        let message = '<p>üéÅ –í—ã –ø–æ–ª—É—á–∏–ª–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å: ';

        // –ï—Å–ª–∏ –±–æ–Ω—É—Å –±—ã–ª –≤–∑—è—Ç –≤—á–µ—Ä–∞, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–µ—Ä–∏—é
        if (p.bonus.lastClaimed && new Date(p.bonus.lastClaimed).setHours(0,0,0,0) === yesterday) {
            p.bonus.streak++;
            bonusAmount += (p.bonus.streak * 5000); // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –±–æ–Ω—É—Å –∑–∞ —Å–µ—Ä–∏—é
            message += `<b class="text-green-400">${formatCurrency(bonusAmount)}</b> (—Å–µ—Ä–∏—è ${p.bonus.streak} –¥–Ω–µ–π)!</p>`;
        } else {
            // –°–µ—Ä–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–∞ –∏–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –±–æ–Ω—É—Å
            p.bonus.streak = 1;
            message += `<b class="text-green-400">${formatCurrency(bonusAmount)}</b> (–Ω–∞—á–∞–ª–æ —Å–µ—Ä–∏–∏)!</p>`;
        }

        p.balance += bonusAmount;
        p.bonus.lastClaimed = now;
        p.bonus.lastClaimDay = today; // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ–Ω—å –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤—ã–¥–∞—á–∏ –±–æ–Ω—É—Å–∞

        addBotMessage(message, true);
        showView('main');
    }

    async function createDeposit(amount, rate) {
        const p = gameState.player;

        if (isNaN(amount) || amount <= 0 || isNaN(rate) || rate <= 0 || rate > 20) {
            addBotMessage("<p>‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∞. –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∏ –ø—Ä–æ—Ü–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, 100000 5).</p>");
            showView('deposits');
            return;
        }
        if (p.balance < amount) {
            addBotMessage("<p>‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤–∫–ª–∞–¥–∞.</p>");
            showView('deposits');
            return;
        }

        p.balance -= amount;
        const payoutTime = Date.now() + (3 * 24 * 60 * 60 * 1000); // 3 –¥–Ω—è
        p.deposits.push({
            amount: amount,
            rate: rate,
            payoutTime: payoutTime,
            claimed: false,
            createdAt: Date.now()
        });
        addBotMessage(`<p>‚úÖ –í–∫–ª–∞–¥ –Ω–∞ ${formatCurrency(amount)} –ø–æ–¥ ${rate}% –æ—Ç–∫—Ä—ã—Ç! –í—ã–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ 3 –¥–Ω—è.</p>`);
        await savePlayerState(); // Make sure to save the state after modifying it
        showView('deposits');
    }

    function createDepositPrompt() {
        addBotMessage("<p>üí∞ –ß—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥, –≤–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∏ –ø—Ä–æ—Ü–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, 100000 5, –≥–¥–µ 5 - —ç—Ç–æ 5%).<br>–í–∫–ª–∞–¥ –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 3 –¥–Ω—è.</p>");
        renderInput("–°—É–º–º–∞ –ü—Ä–æ—Ü–µ–Ω—Ç...", 'view_deposits');
        gameState.prompt = { callback: async (input) => {
                const parts = input.split(' ');
                const amount = parseAmount(parts[0]);
                const rate = parseFloat(parts[1]);

                if (isNaN(amount) || amount <= 0 || isNaN(rate) || rate <= 0 || rate > 20) { // –û–≥—Ä–∞–Ω–∏—á–∏–º –ø—Ä–æ—Ü–µ–Ω—Ç –¥–æ 20
                    addBotMessage("<p>‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∏ –ø—Ä–æ—Ü–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, 100000 5).</p>");
                    showView('deposits');
                    return;
                }
                if (gameState.player.balance < amount) {
                    addBotMessage("<p>‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤–∫–ª–∞–¥–∞.</p>");
                    showView('deposits');
                    return;
                }

                // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é createDeposit, –∫–æ—Ç–æ—Ä–∞—è —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–æ–≥–∏–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                await createDeposit(amount, rate);
                // showView('deposits'); // –≠—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–∞ –≤–Ω—É—Ç—Ä–∏ createDeposit
            }};
    }

    function showInventory() {
        const p = gameState.player;
        let msg = '<p><b>üì¶ –í–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å:</b></p><hr class="border-gray-600 my-1">';
        const buttons = [];
        if (!p.inventory || p.inventory.length === 0) {
            msg += "<p>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç.</p>";
        } else {
            p.inventory.forEach(item => {
                if (item.type === 'case') {
                    msg += `<p>${item.icon} ${item.name} (${item.quantity} —à—Ç.)</p><hr class="border-gray-600 my-1">`;
                }
            });
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–µ–π—Å–∞–º–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            p.inventory.forEach(item => {
                if (item.type === 'case') {
                    buttons.push({ label: `–£–ø—Ä–∞–≤–ª—è—Ç—å ${item.name}`, command: `item_manage ${item.id}` });
                }
            });
        }
        buttons.push({ label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back' });
        addBotMessage(msg, true);
        renderKeyboard(buttons);
    }

    function showItemManagement(itemId) {
        const p = gameState.player;
        const playerItem = p.inventory.find(i => i.id === itemId);
        if (!playerItem) {
            addBotMessage("<p>‚ùå –ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ.</p>");
            showView('inventory');
            return;
        }
        gameState.currentManagedItemId = itemId; // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —É–ø—Ä–∞–≤–ª—è–µ–º–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞

        let msg = `<p><b>${playerItem.icon} ${playerItem.name} (${playerItem.quantity} —à—Ç.)</b></p><hr class="border-gray-600 my-1">`;
        if (playerItem.type === 'case') {
            msg += `<p>–ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å —Å —ç—Ç–∏–º –∫–µ–π—Å–æ–º?</p>`;
        }
        addBotMessage(msg, true);
        showView('item_management'); // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–µ–∂–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–æ–º, –≥–¥–µ –∫–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã
    }

    // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: addItemToInventory
    function addItemToInventory(itemToAdd) {
        const p = gameState.player;
        const existingItem = p.inventory.find(i => i.id === itemToAdd.id && i.type === itemToAdd.type);

        if (existingItem) {
            existingItem.quantity += itemToAdd.quantity;
        } else {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –º—É—Ç–∞—Ü–∏–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ config
            p.inventory.push({ ...itemToAdd });
        }
    }

    // –§–£–ù–ö–¶–ò–Ø showShop (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–∞, —Ç–∞–∫ –∫–∞–∫ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è)
    function showShop() {
        let msg = '<p><b>üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω:</b></p><hr class="border-gray-600 my-1">';
        for (const key in config.donationCases) {
            const item = config.donationCases[key];
            msg += `<div class="bonus-card p-4 rounded-xl mb-2 relative overflow-hidden">
                        <div class="relative z-10 flex flex-col items-center">
                            <span class="text-4xl mb-2">${item.icon}</span>
                            <p class="text-xl font-bold text-center">${item.name}</p>
                            <p class="text-gray-300 text-center">${item.price} –≥–æ–ª–æ—Å–æ–≤</p>
                            <button onclick="window.sendCommand('shop_buy ${item.id}', '–ö—É–ø–∏—Ç—å ${item.name}', true)"
                                    class="mt-3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out">
                                –ö—É–ø–∏—Ç—å
                            </button>
                        </div>
                    </div>`;
        }
        addBotMessage(msg, true);
        showView('shop');
    }

    // –§–£–ù–ö–¶–ò–Ø initiatePayment (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–∞, —Ç–∞–∫ –∫–∞–∫ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è)
    async function initiatePayment(itemId) {
        const item = config.donationCases[itemId];
        if (!item) {
            addBotMessage("<p>‚ùå –¢–∞–∫–æ–π —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –º–∞–≥–∞–∑–∏–Ω–µ.</p>");
            showView('shop');
            return;
        }

        try {
            const result = await vkBridge.send('VKWebAppOpenPayForm', {
                app_id: appId,
                action: 'pay-to-group', // –ò–ª–∏ 'pay-to-app' –µ—Å–ª–∏ —ç—Ç–æ –ø–æ–∫—É–ø–∫–∞ –≤–Ω—É—Ç—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                params: {
                    amount: item.price,
                    description: `–ü–æ–∫—É–ø–∫–∞: ${item.name}`,
                    data: JSON.stringify({ item_id: item.id, user_id: userId }) // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
                }
            });

            if (result.status === 'success') {
                addBotMessage(`<p>‚úÖ –ü–æ–∫—É–ø–∫–∞ "${item.name}" —É—Å–ø–µ—à–Ω–æ —Å–æ–≤–µ—Ä—à–µ–Ω–∞! –í—ã –ø–æ–ª—É—á–∏–ª–∏:</p>`, true);
                const p = gameState.player;
                if (item.content.balance) {
                    p.balance += item.content.balance;
                    addBotMessage(`<p>- ${formatCurrency(item.content.balance)}</p>`, true);
                }
                if (item.content.bitcoin) {
                    p.bitcoin += item.content.bitcoin;
                    addBotMessage(`<p>- ${formatBTC(item.content.bitcoin)}</p>`, true);
                }
                if (item.content.euro) {
                    p.euro += item.content.euro;
                    addBotMessage(`<p>- ${formatEuro(item.content.euro)}</p>`, true);
                }
                if (item.content.items && item.content.items.length > 0) {
                    item.content.items.forEach(lootItem => {
                        addItemToInventory(lootItem);
                        addBotMessage(`<p>- ${lootItem.icon} ${lootItem.name} (${lootItem.quantity} —à—Ç.)</p>`, true);
                    });
                }
                await savePlayerState();
            } else if (result.status === 'cancel') {
                addBotMessage("<p>‚ÑπÔ∏è –û–ø–ª–∞—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.</p>");
            } else {
                addBotMessage("<p>‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–≤–µ—Ä—à–µ–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.</p>");
                console.error("Payment error:", result);
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ VKWebAppOpenPayForm:", error);
            addBotMessage("<p>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –æ–ø–ª–∞—Ç—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–º–µ–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.</p>");
        }
        showView('shop'); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω
    }

    // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: openCase
    async function openCase(caseId, count = 1) {
        const p = gameState.player;
        const playerCase = p.inventory.find(i => i.id === caseId && i.type === 'case');

        if (!playerCase || playerCase.quantity < count) {
            addBotMessage("<p>‚ùå –£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–∞–∫–∏—Ö –∫–µ–π—Å–æ–≤.</p>");
            showView('inventory');
            return;
        }

        let totalLoot = 0;
        let message = `<p>üéâ –í—ã –æ—Ç–∫—Ä—ã–ª–∏ ${count} ${config.cases[caseId].name} –∏ –ø–æ–ª—É—á–∏–ª–∏:</p>`;

        for (let i = 0; i < count; i++) {
            const possibleLoot = config.cases[caseId].possibleLoot;
            const loot = possibleLoot[Math.floor(Math.random() * possibleLoot.length)];
            totalLoot += loot;
        }

        p.balance += totalLoot;
        playerCase.quantity -= count;

        message += `<p>üí∞ ${formatCurrency(totalLoot)}</p>`;
        addBotMessage(message, true);

        // –ï—Å–ª–∏ –∫–µ–π—Å–æ–≤ –±–æ–ª—å—à–µ –Ω–µ—Ç, —É–¥–∞–ª—è–µ–º –∏—Ö –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        if (playerCase.quantity <= 0) {
            p.inventory = p.inventory.filter(item => item.id !== caseId || item.type !== 'case');
        }

        await savePlayerState();
        showView('inventory');
    }

    // –¢–û–ß–ö–ê –í–•–û–î–ê –í –ü–†–ò–õ–û–ñ–ï–ù–ò–ï ---
    async function initApp() {
        try {
            // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è VK Bridge
            await vkBridge.send('VKWebAppInit');

            // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase (–∏—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω–Ω—É—é –≥–ª–æ–±–∞–ª—å–Ω–æ firebaseConfig)
            const app = initializeApp(firebaseConfig); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π firebaseConfig
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('error'); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫ –¥–ª—è Firebase

            // 3. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –ª–∏ __initial_auth_token –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ–Ω–∞ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token && __initial_auth_token !== '') {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await setPersistence(auth, browserLocalPersistence);
                await signInAnonymously(auth);
            }
            userId = auth.currentUser.uid;

            // 4. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è VK
            const vkUserData = await vkBridge.send('VKWebAppGetUserInfo');

            // 5. –ó–∞–≥—Ä—É–∑–∫–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞ –≤ Firestore
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π appId –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—É—Ç–∏
            const playerDocRef = doc(db, `/artifacts/${appId}/users/${userId}/gameData/player`);
            const playerDoc = await getDoc(playerDocRef);

            if (playerDoc.exists()) {
                // –ò–≥—Ä–æ–∫ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
                gameState.player = playerDoc.data();
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—ä–µ–∫—Ç—ã Date
                gameState.player.joinDate = new Date(gameState.player.joinDate);
            } else {
                // –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫, —Å–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                gameState.player = {
                    id: vkUserData.id,
                    name: vkUserData.first_name || '–ò–≥—Ä–æ–∫',
                    balance: 50000, euro: 0, bitcoin: 0, reputation: 0,
                    joinDate: Date.now(), level: 1, xp: 0,
                    businesses: [], businessSlots: 1, isVip: false, deposits: [],
                    achievements: { completed: 0, total: 85 },
                    createdPromos: [], usedPromoCodes: [],
                    pension: { lastClaimed: 0 },
                    bonus: { lastClaimed: 0, streak: 0, lastClaimDay: 0 },
                    inventory: [{ id: 'basic_case', name: '–ë–∞–∑–æ–≤—ã–π –∫–µ–π—Å', icon: 'üì¶', quantity: 1, type: 'case' }]
                };
                await savePlayerState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –≤ –ë–î
            }

            // 6. –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ UI
            gameState.currentMenu = 'main';
            gameState.menuHistory = [];
            gameState.prompt = null;

            document.getElementById('bot-avatar').src = vkUserData.photo_100 || 'https://placehold.co/100x100/1a202c/ffffff?text=M';
            document.getElementById('bot-name').textContent = "–ê—Ç–ª–∞–Ω—Ç: " + gameState.player.name;

            // 7. –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É
            loadingScreen.style.display = 'none';
            appContainer.style.display = 'flex';
            addBotMessage(`üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${gameState.player.name}!`);
            showInitialProfile();
            renderKeyboard();
            setInterval(gameTick, 1000); // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –∏–≥—Ä–æ–≤–æ–π —Ç–∏–∫ —Ä–∞–±–æ—Ç–∞–ª

        } catch (error) {
            console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ", error);
            loadingScreen.innerHTML = '<p class="text-red-400">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ.</p>';
        }
    }

    // --- –ü—Ä–∏–≤—è–∑–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π –∫ window –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ HTML ---
    window.sendCommand = (command, label, isNavCommand = false) => {
        const navCommands = ['back', 'back_to_main'];
        if (!isNavCommand && !navCommands.includes(command.split(' ')[0]) && label && typeof label === 'string' && label !== 'undefined' && gameState.prompt === null) {
            addUserMessage(label);
        }
        const [cmd, ...args] = command.split(' ');
        setTimeout(() => {
            if (cmd.startsWith('view_')) { showView(cmd.replace('view_', '')); return; }
            const commandHandlers = {
                'back': goBack,
                'back_to_main': backToMain,
                'get_bonus': () => { claimBonus(); savePlayerState(); },
                'profile_levels': showLevels,
                'profile_businesses': showBusinesses,
                'market_businesses': showMarketBusinesses,
                'work_start': async () => { await startWork(parseInt(args[0])); }, // savePlayerState —É–∂–µ –≤–Ω—É—Ç—Ä–∏ startWork
                'mining_activate': async () => { activateMining(); await savePlayerState(); },
                'mining_upgrade_prompt': upgradeMiningPrompt,
                'mining_upgrade_execute': async () => { await upgradeMiningExecute(); }, // savePlayerState —É–∂–µ –≤–Ω—É—Ç—Ä–∏ upgradeMiningExecute
                'mining_claim': async () => { claimMinedBtc(); await savePlayerState(); }, // savePlayerState —É–∂–µ –≤–Ω—É—Ç—Ä–∏ claimMinedBtc
                'mining_sell_prompt': sellBtcPrompt,
                'promo_activate_prompt': activatePromoPrompt, // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ activatePromoPrompt –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
                'bank_pension': async () => { claimPension(); await savePlayerState(); },
                'deposit_create_prompt': createDepositPrompt,
                'deposit_create_execute': async () => { await createDeposit(parseInt(args[0]), parseAmount(args[1])); }, // savePlayerState —É–∂–µ –≤–Ω—É—Ç—Ä–∏ createDeposit
                'biz_buy': async () => { await buyBusiness(parseInt(args[0])); }, // savePlayerState —É–∂–µ –≤–Ω—É—Ç—Ä–∏ buyBusiness
                'profile_inventory': showInventory,
                'item_manage': () => showItemManagement(args[0]),
                'case_open': (a,b,c) => openCase(args[0], args[1]), // savePlayerState —É–∂–µ –≤–Ω—É—Ç—Ä–∏ openCase
                'view_shop': showShop,
                'shop_buy': () => initiatePayment(args[0]), // savePlayerState —É–∂–µ –≤–Ω—É—Ç—Ä–∏ initiatePayment
                // ... –¥–æ–±–∞–≤—å—Ç–µ —Å—é–¥–∞ –¥—Ä—É–≥–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –∏–∑–º–µ–Ω—è—é—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                'profile_stats': showInitialProfile // –î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            };
            if (commandHandlers[cmd]) {
                commandHandlers[cmd]();
            } else if (!isNavCommand && label && typeof label === 'string' && label !== 'undefined') {
                addBotMessage(`<p>–†–∞–∑–¥–µ–ª ¬´${label}¬ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</p>`);
            }
        }, 200);
    };
    window.submitInput = () => { const i = document.getElementById('text-input'), v = i.value; if (!v.trim()) return; addUserMessage(v); if (gameState.prompt && typeof gameState.prompt.callback === 'function') { const cb = gameState.prompt.callback; gameState.prompt = null; cb(v); } };
    // –§—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –º–µ–Ω—è—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å
    window.formatCurrency = formatCurrency;
    window.formatBTC = formatBTC;
    window.formatEuro = formatEuro;
    window.formatTime = formatTime;
    window.formatFullDate = formatFullDate;
    window.getDaysInGame = getDaysInGame;
    window.getXpForNextLevel = getXpForNextLevel;
    window.parseAmount = parseAmount;
    window.addBotMessage = addBotMessage;
    window.addUserMessage = addUserMessage;
    window.renderKeyboard = renderKeyboard;
    window.renderInput = renderInput;
    window.showView = showView;
    window.goBack = goBack;
    window.backToMain = backToMain;
    window.savePlayerState = savePlayerState;
    window.startWork = startWork;
    window.gameTick = gameTick;
    window.checkLevelUp = checkLevelUp;
    window.showInitialProfile = showInitialProfile;
    window.showLevels = showLevels;
    window.showBusinesses = showBusinesses;
    window.showMarketBusinesses = showMarketBusinesses;
    window.buyBusiness = buyBusiness;
    window.activateMining = activateMining;
    window.upgradeMiningPrompt = upgradeMiningPrompt;
    window.upgradeMiningExecute = upgradeMiningExecute;
    window.claimMinedBtc = claimMinedBtc;
    window.sellBtcPrompt = sellBtcPrompt;
    window.claimPension = claimPension;
    window.claimBonus = claimBonus;
    window.createDepositPrompt = createDepositPrompt;
    window.createDeposit = createDeposit;
    window.showInventory = showInventory;
    window.showItemManagement = showItemManagement;
    window.openCase = openCase;
    window.showShop = showShop;
    window.initiatePayment = initiatePayment;
    window.addItemToInventory = addItemToInventory;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    initApp();
</script>
</body>
</html>