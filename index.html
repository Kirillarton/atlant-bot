<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, user-scalable=no, viewport-fit=cover">
    <title>–°–∏–º—É–ª—è—Ç–æ—Ä –ë–æ—Ç–∞ ¬´–ê—Ç–ª–∞–Ω—Ç¬ª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- –°–∫—Ä–∏–ø—Ç VK Bridge –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –í–ö–æ–Ω—Ç–∞–∫—Ç–µ -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .chat-bubble { max-width: 85%; word-wrap: break-word; }
        .chat-container::-webkit-scrollbar { width: 4px; }
        .chat-container::-webkit-scrollbar-thumb { background-color: #4A5568; border-radius: 20px; }
        .keyboard-grid button { transition: all 0.2s ease-in-out; }
        .keyboard-grid button:active { transform: scale(0.95); }
        .bonus-card {
            background-image: url('https://img.freepik.com/free-vector/abstract-plexus-background-with-connecting-dots-lines_1017-23348.jpg?w=1380&t=st=1719427845~exp=1719428445~hmac=e20f269a31a4c0a5d4e135b026615b3c3b53f6834b126ac002b4742e7428f522');
            background-size: cover;
            background-position: center;
            border: 1px solid #718096;
            position: relative;
        }
        .bonus-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(45, 55, 72, 0.7); border-radius: 0.75rem; }
        .bonus-card > * { position: relative; z-index: 10; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-2 md:p-4">

<div id="app-container" class="w-full max-w-lg bg-gray-800 rounded-2xl shadow-2xl flex flex-col h-[95vh] md:h-[90vh]" style="display: none;">
    <!-- –®–∞–ø–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div class="p-4 border-b border-gray-700 flex items-center space-x-4 flex-shrink-0">
        <div class="relative">
            <img id="bot-avatar" class="w-12 h-12 rounded-full" src="https://placehold.co/100x100/1a202c/ffffff?text=M" alt="–ê–≤–∞—Ç–∞—Ä –ë–æ—Ç–∞">
            <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-gray-800 rounded-full"></span>
        </div>
        <div>
            <h1 id="bot-name" class="text-xl font-bold">–ê—Ç–ª–∞–Ω—Ç –ë–æ—Ç</h1>
            <p class="text-sm text-green-400">–≤ —Å–µ—Ç–∏</p>
        </div>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
    <div id="chat-container" class="flex-1 p-4 space-y-4 overflow-y-auto chat-container"></div>

    <!-- –û–±–ª–∞—Å—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã -->
    <div id="keyboard-area" class="p-3 bg-gray-900/50 border-t border-gray-700 flex-shrink-0"></div>
</div>

<div id="loading-screen" class="flex flex-col items-center justify-center">
    <div class="loader"></div>
    <p class="mt-4 text-lg">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

    // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è Firebase –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã ---
    let db, auth, userId, appId;
    const appContainer = document.getElementById('app-container');
    const loadingScreen = document.getElementById('loading-screen');

    // --- –í–ê–®–ê –ü–ï–†–°–û–ù–ê–õ–¨–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDFWm4OyjHgAsgVTMkhApeGaAZC5CSXEi8",
        authDomain: "atlant-bot-1d0d5.firebaseapp.com",
        projectId: "atlant-bot-1d0d5",
        storageBucket: "atlant-bot-1d0d5.firebasestorage.app",
        messagingSenderId: "1002159529192",
        appId: "1:1002159529192:web:cac088727395f079e9fd5d",
        measurementId: "G-29FH6CDF19"
    };

    // --- –ó–ê–ì–õ–£–®–ö–ê VK BRIDGE –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø –í –ë–†–ê–£–ó–ï–†–ï ---
    if (typeof vkBridge === 'undefined') {
        console.warn('VK Bridge –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–æ–∫-–æ–±—ä–µ–∫—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.');
        window.vkBridge = {
            send: (method, params) => {
                console.log('–í—ã–∑–æ–≤ –º–æ–∫-–æ–±—ä–µ–∫—Ç–∞ VK Bridge:', method, params);
                return new Promise((resolve, reject) => {
                    switch (method) {
                        case 'VKWebAppInit':
                            resolve({ result: true });
                            break;
                        case 'VKWebAppGetUserInfo':
                            resolve({ id: 1, first_name: '–ü–∞–≤–µ–ª', last_name: '–î—É—Ä–æ–≤', photo_100: 'https://placehold.co/100x100/7f9aed/ffffff?text=VK' });
                            break;
                        case 'VKWebAppOpenPayForm':
                            // –ò–º–∏—Ç–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –æ–ø–ª–∞—Ç—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                            alert(`–ú–æ–∫-–æ–ø–ª–∞—Ç–∞ –∑–∞: ${params.params.item}. –¶–µ–Ω–∞: ${params.params.price} –≥–æ–ª–æ—Å–æ–≤.`);
                            resolve({ status: 'success', transaction_id: 'MOCK_TRANSACTION_123' });
                            break;
                        default:
                            resolve({ result: true });
                    }
                });
            }
        };
    }

    // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò–ì–†–´ ---
    const config = {
        workContracts: [
            { id: 1, title: "–î–æ—Å—Ç–∞–≤–∫–∞ –ø–∏—Ü—Ü—ã", duration: 60, minReward: 5000, maxReward: 10000, risk: 0.1, requiredLevel: 1 },
            { id: 2, title: "–ü–µ—Ä–µ–≤–æ–∑–∫–∞ –º–µ–±–µ–ª–∏", duration: 180, minReward: 30000, maxReward: 50000, risk: 0.2, requiredLevel: 5 },
            { id: 3, title: "–ö–æ–Ω—Ç—Ä–∞–±–∞–Ω–¥–∞ —á–∏–ø–æ–≤", duration: 300, minReward: 100000, maxReward: 250000, risk: 0.4, requiredLevel: 10 },
        ],
        cases: {
            'basic_case': { id: 'basic_case', name: "–ë–∞–∑–æ–≤—ã–π –∫–µ–π—Å", icon: "üì¶", possibleLoot: [50000, 100000, 200000, 300000, 500000] },
            'pro_case': { id: 'pro_case', name: "–ü—Ä–æ-–∫–µ–π—Å", icon: "üíº", possibleLoot: [100000, 200000, 350000, 500000, 750000] },
            'elite_case': { id: 'elite_case', name: "–≠–ª–∏—Ç–Ω—ã–π –∫–µ–π—Å", icon: "üëë", possibleLoot: [150000, 300000, 450000, 600000, 750000] },
            'ultra_case': { id: 'ultra_case', name: "–£–ª—å—Ç—Ä–∞ –∫–µ–π—Å", icon: "üíé", possibleLoot: [250000, 500000, 750000, 1000000, 1500000] }
        },
        // --- –ù–û–í–´–ï –î–û–ù–ê–¢ –ö–ï–ô–°–´ ---
        donationCases: {
            'starter_pack': { id: 'starter_pack', name: '–ù–∞–±–æ—Ä –ù–æ–≤–∏—á–∫–∞', icon: 'üöÄ', price: 10, content: { balance: 500000, items: [{id: 'basic_case', quantity: 5}] } },
            'tycoon_case': { id: 'tycoon_case', name: '–ö–µ–π—Å –ë–∏–∑–Ω–µ—Å–º–µ–Ω–∞', icon: 'üé©', price: 50, content: { balance: 2500000, items: [{id: 'pro_case', quantity: 3}, {id: 'elite_case', quantity: 1}] } },
            'investor_bundle': { id: 'investor_bundle', name: '–ù–∞–±–æ—Ä –ò–Ω–≤–µ—Å—Ç–æ—Ä–∞', icon: 'üìà', price: 100, content: { bitcoin: 50, euro: 100, items: [{id: 'ultra_case', quantity: 2}] } }
        },
        businessesForSale: [
            { id: 12, name: "–ö–∏—Ç–∞–π—Å–∫–∏–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω", price: 35000000, profit: 154000 },
            { id: 15, name: "–®–∞—É—Ä–º–∏—á–Ω–∞—è", price: 5000000, profit: 25000 },
            { id: 18, name: "–ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å", price: 50000000, profit: 250000 },
        ]
    };

    // --- –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ ---
    let gameState = {};

    // --- –≠–õ–ï–ú–ï–ù–¢–´ –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
    const chatContainer = document.getElementById('chat-container');
    const keyboardArea = document.getElementById('keyboard-area');

    // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
    function formatCurrency(n, c = '$') { return `üí∞ ${new Intl.NumberFormat('ru-RU').format(Math.round(n))}${c}`; }
    function formatBTC(n) { return `üíé ${(n || 0).toFixed(4)}‚Çø`; }
    function formatEuro(n) { return `üí∂ ${new Intl.NumberFormat('ru-RU').format(Math.round(n))}‚Ç¨`; }
    function formatTime(ms) { if (ms <= 0) return "0 —Å–µ–∫."; let s = Math.floor((ms / 1000) % 60), m = Math.floor((ms / 60000) % 60), h = Math.floor(ms / 3600000); return `${h} —á. ${m} –º–∏–Ω. ${s} —Å–µ–∫.`; }
    function formatFullDate(d) { return new Date(d).toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }
    function getDaysInGame(joinTimestamp) { return Math.floor((Date.now() - joinTimestamp) / 86400000); }
    function getXpForNextLevel(l) { return 4 + (4 * l); }
    function parseAmount(str) { let s = String(str).toLowerCase().trim().replace(/–∫/g, 'k'); let value = parseFloat(s.replace(/,/g, '')); if (s.endsWith('kk')) { value *= 1000000; } else if (s.endsWith('k')) { value *= 1000; } return isNaN(value) ? 0 : value; }

    // --- –°–û–•–†–ê–ù–ï–ù–ò–ï –î–ê–ù–ù–´–• –í FIRESTORE ---
    async function savePlayerState() {
        if (!db || !userId) return;
        try {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç player –≤ JSON-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç
            const stateToSave = JSON.parse(JSON.stringify(gameState.player));
            const playerDocRef = doc(db, `/artifacts/${appId}/users/${userId}/gameData/player`);
            await setDoc(playerDocRef, stateToSave);
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞: ", error);
            addBotMessage('<p class="text-red-400">‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>');
        }
    }

    // --- –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ì–†–´ (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º) ---
    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (addBotMessage, addUserMessage, renderKeyboard –∏ —Ç.–¥. –æ—Å—Ç–∞—é—Ç—Å—è)
    // ... (–≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–¥–∞, –Ω–æ —Å –≤—ã–∑–æ–≤–æ–º savePlayerState() –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è gameState.player)

    // –ü–µ—Ä–µ–¥–µ–ª–∞–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    async function createPromoExecute(name, currency, reward, count) {
        const p = gameState.player;
        const totalCost = reward * count;
        let balanceType = 'balance';
        if (currency === '‚Çø') balanceType = 'bitcoin';
        if (currency === '‚Ç¨') balanceType = 'euro';

        if (p[balanceType] < totalCost) {
            addBotMessage('<p>‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞.</p>');
            return;
        }

        const promoId = name.toUpperCase();
        const publicPromoRef = doc(db, `/artifacts/${appId}/public/data/promos/${promoId}`);
        const promoData = {
            creatorId: userId,
            creatorName: p.name,
            reward: reward,
            currency: currency,
            balanceType: balanceType,
            activationsLeft: count,
            createdAt: Date.now()
        };

        const promoDoc = await getDoc(publicPromoRef);
        if (promoDoc.exists()) {
            addBotMessage('<p>‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.</p>');
            return;
        }

        p[balanceType] -= totalCost;
        if (!p.createdPromos) p.createdPromos = [];
        p.createdPromos.push({ name: promoId, count: count, reward: reward, currency: currency });

        try {
            await setDoc(publicPromoRef, promoData);
            await savePlayerState();
            addBotMessage(`<p>‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ ¬´${promoId}¬ª –Ω–∞ ${count} –∞–∫—Ç–∏–≤–∞—Ü–∏–π —Å–æ–∑–¥–∞–Ω!</p>`);
            showView('promo');
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞: ", error);
            // –í–µ—Ä–Ω—É—Ç—å –¥–µ–Ω—å–≥–∏ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∑–∞–ø–∏—Å–∏
            p[balanceType] += totalCost;
            addBotMessage('<p>‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>');
        }
    }

    async function activatePromoPrompt() {
        addBotMessage("<p>üéÅ –í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏</p>");
        renderInput("–ü—Ä–æ–º–æ–∫–æ–¥...", 'view_promo');
        gameState.prompt = { callback: async (code) => {
                const promoId = code.toUpperCase();
                const p = gameState.player;

                if (p.usedPromoCodes.includes(promoId)) {
                    addBotMessage("<p>‚ùå –í—ã —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥.</p>");
                    showView('promo');
                    return;
                }

                const publicPromoRef = doc(db, `/artifacts/${appId}/public/data/promos/${promoId}`);

                try {
                    const promoDoc = await getDoc(publicPromoRef);
                    if (!promoDoc.exists() || promoDoc.data().activationsLeft <= 0) {
                        addBotMessage("<p>‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è.</p>");
                        showView('promo');
                        return;
                    }

                    const promoData = promoDoc.data();
                    p[promoData.balanceType] += promoData.reward;
                    p.usedPromoCodes.push(promoId);

                    await updateDoc(publicPromoRef, { activationsLeft: promoData.activationsLeft - 1 });
                    await savePlayerState();

                    let currencySymbol = '$';
                    if (promoData.currency === '‚Ç¨') currencySymbol = '‚Ç¨';
                    if (promoData.currency === '‚Çø') currencySymbol = '‚Çø';

                    addBotMessage(`<p>‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω ¬´${promoId}¬ª<br>+${formatCurrency(promoData.reward, currencySymbol)}</p>`);
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞: ", error);
                    addBotMessage('<p>‚ö†Ô∏è –û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>');
                }

                showView('promo');
            }};
    }

    async function openCase(itemId, countStr) {
        const count = parseInt(countStr);
        const p = gameState.player;
        const playerItem = p.inventory.find(i => i.id === itemId);
        const caseInfo = config.cases[itemId];

        if (!playerItem || playerItem.quantity < count) {
            addBotMessage('<p>‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–µ–π—Å–æ–≤ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è.</p>');
            return;
        }

        let totalWinnings = 0;
        let results = [];
        for (let i = 0; i < count; i++) {
            const loot = caseInfo.possibleLoot[Math.floor(Math.random() * caseInfo.possibleLoot.length)];
            totalWinnings += loot;
            results.push(loot);
        }

        p.balance += totalWinnings;
        playerItem.quantity -= count;
        if (playerItem.quantity <= 0) {
            p.inventory = p.inventory.filter(i => i.id !== itemId);
        }

        let resultMessage = `<p><b>üéâ –í–æ—Ç —á—Ç–æ –≤—ã–ø–∞–ª–æ (${count}x ${caseInfo.icon} ${caseInfo.name}):</b><br>`;
        results.forEach(res => {
            resultMessage += `üí∞ ${new Intl.NumberFormat('ru-RU').format(res)}$<br>`;
        });
        resultMessage += `<hr class="border-gray-600 my-1">–û–±—â–∏–π –≤—ã–∏–≥—Ä—ã—à: <b class="text-green-400">${new Intl.NumberFormat('ru-RU').format(totalWinnings)}$</b></p>`;

        addBotMessage(resultMessage);
        await savePlayerState();
        showView('profile_inventory');
    }

    // --- –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ú–ê–ì–ê–ó–ò–ù–ê –ò –û–ü–õ–ê–¢–´ ---
    function showShop() {
        let msg = '<p>üè™ <b>–ú–∞–≥–∞–∑–∏–Ω (–î–æ–Ω–∞—Ç)</b><br><br>–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –Ω–∞–±–æ—Ä—ã –∑–∞ –≥–æ–ª–æ—Å–∞ –í–ö, —á—Ç–æ–±—ã —É—Å–∫–æ—Ä–∏—Ç—å —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å!</p><hr class="border-gray-600 my-2">';
        const buttons = [];
        for (const key in config.donationCases) {
            const item = config.donationCases[key];
            msg += `<p><b>${item.icon} ${item.name}</b><br>–¶–µ–Ω–∞: ${item.price} –≥–æ–ª–æ—Å–æ–≤</p><hr class="border-gray-600 my-1">`;
            buttons.push({label: `–ö—É–ø–∏—Ç—å (${item.price} –≥–æ–ª.)`, command: `shop_buy ${item.id}`});
        }
        buttons.push({label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back'});
        addBotMessage(msg, true);
        renderKeyboard(buttons);
    }

    async function initiatePayment(caseId) {
        const itemToBuy = config.donationCases[caseId];
        if (!itemToBuy) {
            addBotMessage("<p>‚ùå –¢–∞–∫–æ–π —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>");
            return;
        }

        try {
            addBotMessage("<p>‚è≥ –û—Ç–∫—Ä—ã–≤–∞—é –æ–∫–Ω–æ –æ–ø–ª–∞—Ç—ã VK Pay...</p>");
            const result = await vkBridge.send('VKWebAppOpenPayForm', {
                app_id: appId, // ID –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                params: {
                    amount: itemToBuy.price,
                    description: `–ü–æ–∫—É–ø–∫–∞ –Ω–∞–±–æ—Ä–∞ "${itemToBuy.name}" –≤ –∏–≥—Ä–µ –ê—Ç–ª–∞–Ω—Ç`,
                    item: `magnate_case_${itemToBuy.id}`
                }
            });

            if (result.status === 'success') {
                addBotMessage(`<p class="text-green-400">‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –ó–∞—á–∏—Å–ª—è–µ–º –≤–∞—à –Ω–∞–±–æ—Ä...</p>`);
                // –ó–∞—á–∏—Å–ª—è–µ–º –ø–æ–∫—É–ø–∫—É
                const content = itemToBuy.content;
                const p = gameState.player;
                if (content.balance) p.balance += content.balance;
                if (content.bitcoin) p.bitcoin += content.bitcoin;
                if (content.euro) p.euro += content.euro;
                if (content.items) {
                    content.items.forEach(purchasedItem => {
                        addItemToInventory(purchasedItem.id, purchasedItem.quantity);
                    });
                }
                await savePlayerState();
                addBotMessage(`<p><b>üéâ ${itemToBuy.name}</b> –ø–æ–ª—É—á–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å –∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å.</p>`);
            } else {
                addBotMessage('<p class="text-yellow-400">‚ö†Ô∏è –û–ø–ª–∞—Ç–∞ –Ω–µ –±—ã–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.</p>');
            }

        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ VK Pay: ", error);
            addBotMessage('<p class="text-red-400">‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞.</p>');
        }
        showView('shop');
    }

    function addItemToInventory(itemId, quantity) {
        const p = gameState.player;
        const itemInfo = config.cases[itemId] || Object.values(config.donationCases).find(c => c.id === itemId);
        if (!itemInfo) return;

        if (!p.inventory) p.inventory = [];
        const existingItem = p.inventory.find(item => item.id === itemId);
        if (existingItem) {
            existingItem.quantity += quantity;
        } else {
            p.inventory.push({
                id: itemId,
                name: itemInfo.name,
                icon: itemInfo.icon,
                quantity: quantity,
                type: 'case'
            });
        }
    }

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
    async function initApp() {
        try {
            // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è VK Bridge
            await vkBridge.send('VKWebAppInit');

            // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            appId = typeof __app_id !== 'undefined' ? __app_id : 123456; // –ó–∞–ø–∞—Å–Ω–æ–π appId
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('error');

            // 3. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await setPersistence(auth, browserLocalPersistence);
                await signInAnonymously(auth);
            }
            userId = auth.currentUser.uid;

            // 4. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è VK
            const vkUserData = await vkBridge.send('VKWebAppGetUserInfo');

            // 5. –ó–∞–≥—Ä—É–∑–∫–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞ –≤ Firestore
            const playerDocRef = doc(db, `/artifacts/${appId}/users/${userId}/gameData/player`);
            const playerDoc = await getDoc(playerDocRef);

            if (playerDoc.exists()) {
                // –ò–≥—Ä–æ–∫ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
                gameState.player = playerDoc.data();
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—ä–µ–∫—Ç—ã Date
                gameState.player.joinDate = new Date(gameState.player.joinDate);
            } else {
                // –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫, —Å–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                gameState.player = {
                    id: vkUserData.id,
                    name: vkUserData.first_name || '–ò–≥—Ä–æ–∫',
                    balance: 50000, euro: 0, bitcoin: 0, reputation: 0,
                    joinDate: Date.now(), level: 1, xp: 0,
                    businesses: [], businessSlots: 1, isVip: false, deposits: [],
                    achievements: { completed: 0, total: 85 },
                    createdPromos: [], usedPromoCodes: [],
                    pension: { lastClaimed: 0 },
                    bonus: { lastClaimed: 0, streak: 0, lastClaimDay: 0 },
                    inventory: [{ id: 'basic_case', name: '–ë–∞–∑–æ–≤—ã–π –∫–µ–π—Å', icon: 'üì¶', quantity: 1, type: 'case' }]
                };
                await savePlayerState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –≤ –ë–î
            }

            // 6. –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ UI
            gameState.currentMenu = 'main';
            gameState.menuHistory = [];
            gameState.prompt = null;

            document.getElementById('bot-avatar').src = vkUserData.photo_100 || 'https://placehold.co/100x100/1a202c/ffffff?text=M';
            document.getElementById('bot-name').textContent = "–ê—Ç–ª–∞–Ω—Ç: " + gameState.player.name;

            // 7. –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É
            loadingScreen.style.display = 'none';
            appContainer.style.display = 'flex';
            addBotMessage(`üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${gameState.player.name}!`);
            showInitialProfile();
            renderKeyboard();
            // setInterval(gameTick, 1000); // –ú–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è —Ç–∏–∫–æ–≤ –≤ —Ñ–æ–Ω–µ

        } catch (error) {
            console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ", error);
            loadingScreen.innerHTML = '<p class="text-red-400">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ.</p>';
        }
    }

    // --- –¢–û–ß–ö–ê –í–•–û–î–ê –í –ü–†–ò–õ–û–ñ–ï–ù–ò–ï ---
    initApp();

    // --- –ü—Ä–∏–≤—è–∑–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π –∫ window –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ HTML ---
    // (–ó–¥–µ—Å—å –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏, –≤—ã–∑—ã–≤–∞–µ–º—ã–µ —á–µ—Ä–µ–∑ onclick)
    window.sendCommand = (command, label, isNavCommand = false) => {
        const navCommands = ['back', 'back_to_main'];
        if (!isNavCommand && !navCommands.includes(command.split(' ')[0]) && label && typeof label === 'string' && label !== 'undefined' && gameState.prompt === null) {
            addUserMessage(label);
        }
        const [cmd, ...args] = command.split(' ');
        setTimeout(() => {
            if (cmd.startsWith('view_')) { showView(cmd.replace('view_', '')); return; }
            const commandHandlers = {
                'back': goBack,
                'back_to_main': backToMain,
                'get_bonus': () => { claimBonus(); savePlayerState(); },
                'profile_levels': showLevels,
                'profile_businesses': showBusinesses,
                'market_businesses': showMarketBusinesses,
                'work_start': async () => { await startWork(parseInt(args[0])); await savePlayerState(); },
                'mining_activate': () => { activateMining(); savePlayerState(); },
                'mining_upgrade_prompt': upgradeMiningPrompt,
                'mining_upgrade_execute': async () => { await upgradeMiningExecute(); await savePlayerState(); },
                'mining_claim': () => { claimMinedBtc(); savePlayerState(); },
                'mining_sell_prompt': sellBtcPrompt,
                'promo_activate_prompt': activatePromoPrompt,
                'bank_pension': () => { claimPension(); savePlayerState(); },
                'deposit_create_prompt': createDepositPrompt,
                'deposit_create_execute': async () => { await createDeposit(parseInt(args[0]), parseAmount(args[1])); },
                'biz_buy': async () => { await buyBusiness(parseInt(args[0])); await savePlayerState(); },
                'profile_inventory': showInventory,
                'item_manage': () => showItemManagement(args[0]),
                'case_open': (a,b,c) => openCase(args[0], args[1]),
                'view_shop': showShop, // –ù–û–í–´–ô –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                'shop_buy': () => initiatePayment(args[0]), // –ù–û–í–´–ô –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                // ... –¥–æ–±–∞–≤—å—Ç–µ —Å—é–¥–∞ –¥—Ä—É–≥–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –∏–∑–º–µ–Ω—è—é—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            };
            if (commandHandlers[cmd]) {
                commandHandlers[cmd]();
            } else if (!isNavCommand && label && typeof label === 'string' && label !== 'undefined') {
                addBotMessage(`<p>–†–∞–∑–¥–µ–ª ¬´${label}¬ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</p>`);
            }
        }, 200);
    };
    window.submitInput = () => { const i = document.getElementById('text-input'), v = i.value; if (!v.trim()) return; addUserMessage(v); if (gameState.prompt && typeof gameState.prompt.callback === 'function') { const cb = gameState.prompt.callback; gameState.prompt = null; cb(v); } };
    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –º–µ–Ω—è—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å
    // –∏–ª–∏ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å, —á—Ç–æ–±—ã –æ–Ω–∏ —Ç–æ–∂–µ –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ window, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.
    // –Ø –æ—Å—Ç–∞–≤–∏–ª —Ç–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏.

</script>
</body>
</html>
