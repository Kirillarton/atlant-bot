<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, user-scalable=no, viewport-fit=cover">
    <title>–°–∏–º—É–ª—è—Ç–æ—Ä –ë–æ—Ç–∞ ¬´–ê—Ç–ª–∞–Ω—Ç¬ª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .chat-bubble { max-width: 85%; word-wrap: break-word; }
        .chat-container::-webkit-scrollbar { width: 4px; }
        .chat-container::-webkit-scrollbar-thumb { background-color: #4A5568; border-radius: 20px; }
        .keyboard-grid button { transition: all 0.2s ease-in-out; }
        .keyboard-grid button:active { transform: scale(0.95); }
        .bonus-card {
            background-image: url('https://img.freepik.com/free-vector/abstract-plexus-background-with-connecting-dots-lines_1017-23348.jpg?w=1380&t=st=1719427845~exp=1719428445~hmac=e20f269a31a4c0a5d4e135b026615b3c3b53f6834b126ac002b4742e7428f522');
            background-size: cover;
            background-position: center;
            border: 1px solid #718096;
            position: relative;
        }
        .bonus-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(45, 55, 72, 0.7);
            border-radius: 0.75rem;
        }
        .bonus-card > * {
            position: relative;
            z-index: 10;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-2 md:p-4">

<div id="app-container" class="w-full max-w-lg bg-gray-800 rounded-2xl shadow-2xl flex flex-col h-[95vh] md:h-[90vh]"
     style="display: none;">
    <div class="p-4 border-b border-gray-700 flex items-center space-x-4 flex-shrink-0">
        <div class="relative">
            <img id="bot-avatar" class="w-12 h-12 rounded-full" src="https://placehold.co/100x100/1a202c/ffffff?text=M"
                 alt="–ê–≤–∞—Ç–∞—Ä –ë–æ—Ç–∞">
            <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-gray-800 rounded-full"></span>
        </div>
        <div>
            <h1 id="bot-name" class="text-xl font-bold">–ê—Ç–ª–∞–Ω—Ç –ë–æ—Ç</h1>
            <p class="text-sm text-green-400">–≤ —Å–µ—Ç–∏</p>
        </div>
    </div>

    <div id="chat-container" class="flex-1 p-4 space-y-4 overflow-y-auto chat-container"></div>

    <div id="keyboard-area" class="p-3 bg-gray-900/50 border-t border-gray-700 flex-shrink-0"></div>
</div>

<div id="loading-screen" class="flex flex-col items-center justify-center">
    <div class="loader"></div>
    <p class="mt-4 text-lg">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

    // --- –í–ê–®–ê –ü–ï–†–°–û–ù–ê–õ–¨–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDFWm4OyjHgAsgVTMkhApeGaAZC5CSXEi8",
        authDomain: "atlant-bot-1d0d5.firebaseapp.com",
        projectId: "atlant-bot-1d0d5",
        storageBucket: "atlant-bot-1d0d5.firebasestorage.app",
        messagingSenderId: "1002159529192",
        appId: "1:1002159529192:web:cac088727395f079e9fd5d",
        measurementId: "G-29FH6CDF19"
    };

    // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è Firebase –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã ---
    let db, auth, userId;
    const appContainer = document.getElementById('app-container');
    const loadingScreen = document.getElementById('loading-screen');
    const appId = 53820374; // ID –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –í–ö–æ–Ω—Ç–∞–∫—Ç–µ

    // --- –ó–ê–ì–õ–£–®–ö–ê VK BRIDGE –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø –í –ë–†–ê–£–ó–ï–†–ï ---
    if (typeof vkBridge === 'undefined') {
        console.warn('VK Bridge –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–æ–∫-–æ–±—ä–µ–∫—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.');
        window.vkBridge = {
            send: (method, params) => {
                console.log('–í—ã–∑–æ–≤ –º–æ–∫-–æ–±—ä–µ–∫—Ç–∞ VK Bridge:', method, params);
                return new Promise((resolve, reject) => {
                    switch (method) {
                        case 'VKWebAppInit':
                            resolve({ result: true });
                            break;
                        case 'VKWebAppGetUserInfo':
                            resolve({ id: 1, first_name: '–ü–∞–≤–µ–ª', last_name: '–î—É—Ä–æ–≤', photo_100: 'https://placehold.co/100x100/7f9aed/ffffff?text=VK' });
                            break;
                        case 'VKWebAppOpenPayForm':
                            // –ò–º–∏—Ç–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –æ–ø–ª–∞—Ç—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                            // –í–º–µ—Å—Ç–æ alert –∏—Å–ø–æ–ª—å–∑—É–µ–º console.log –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å UI
                            console.log(`–ú–æ–∫-–æ–ø–ª–∞—Ç–∞ –∑–∞: ${params.params.item}. –¶–µ–Ω–∞: ${params.params.price} –≥–æ–ª–æ—Å–æ–≤.`);
                            resolve({ status: 'success', transaction_id: 'MOCK_TRANSACTION_123' });
                            break;
                        default:
                            resolve({ result: true });
                    }
                });
            }
        };
    }

    // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò–ì–†–´ ---
    const config = {
        workContracts: [
            { id: 1, title: "–î–æ—Å—Ç–∞–≤–∫–∞ –ø–∏—Ü—Ü—ã", duration: 60, minReward: 5000, maxReward: 10000, risk: 0.1, requiredLevel: 1 },
            { id: 2, title: "–ü–µ—Ä–µ–≤–æ–∑–∫–∞ –º–µ–±–µ–ª–∏", duration: 180, minReward: 30000, maxReward: 50000, risk: 0.2, requiredLevel: 5 },
            { id: 3, title: "–ö–æ–Ω—Ç—Ä–∞–±–∞–Ω–¥–∞ —á–∏–ø–æ–≤", duration: 300, minReward: 100000, maxReward: 250000, risk: 0.4, requiredLevel: 10 },
        ],
        cases: {
            'basic_case': { id: 'basic_case', name: "–ë–∞–∑–æ–≤—ã–π –∫–µ–π—Å", icon: "üì¶", possibleLoot: [50000, 100000, 200000, 300000, 500000] },
            'pro_case': { id: 'pro_case', name: "–ü—Ä–æ-–∫–µ–π—Å", icon: "üíº", possibleLoot: [100000, 200000, 350000, 500000, 750000] },
            'elite_case': { id: 'elite_case', name: "–≠–ª–∏—Ç–Ω—ã–π –∫–µ–π—Å", icon: "üëë", possibleLoot: [150000, 300000, 450000, 600000, 750000] },
            'ultra_case': { id: 'ultra_case', name: "–£–ª—å—Ç—Ä–∞ –∫–µ–π—Å", icon: "üíé", possibleLoot: [250000, 500000, 750000, 1000000, 1500000] }
        },
        donationCases: {
            'starter_pack': { id: 'starter_pack', name: '–ù–∞–±–æ—Ä –ù–æ–≤–∏—á–∫–∞', icon: 'üöÄ', price: 10, content: { balance: 500000, items: [{ id: 'basic_case', quantity: 5, type: 'case', name: '–ë–∞–∑–æ–≤—ã–π –∫–µ–π—Å', icon: 'üì¶' }] } },
            'tycoon_case': { id: 'tycoon_case', name: '–ö–µ–π—Å –ë–∏–∑–Ω–µ—Å–º–µ–Ω–∞', icon: 'üé©', price: 50, content: { balance: 2500000, items: [{ id: 'pro_case', quantity: 3, type: 'case', name: '–ü—Ä–æ-–∫–µ–π—Å', icon: 'üíº' }, { id: 'elite_case', quantity: 1, type: 'case', name: '–≠–ª–∏—Ç–Ω—ã–π –∫–µ–π—Å', icon: 'üëë' }] } },
            'investor_bundle': { id: 'investor_bundle', name: '–ù–∞–±–æ—Ä –ò–Ω–≤–µ—Å—Ç–æ—Ä–∞', icon: 'üìà', price: 100, content: { bitcoin: 50, euro: 100, items: [{ id: 'ultra_case', quantity: 2, type: 'case', name: '–£–ª—å—Ç—Ä–∞ –∫–µ–π—Å', icon: 'üíé' }] } }
        },
        businessesForSale: [
            { id: 12, name: "–ö–∏—Ç–∞–π—Å–∫–∏–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω", price: 35000000, profit: 154000 },
            { id: 15, name: "–®–∞—É—Ä–º–∏—á–Ω–∞—è", price: 5000000, profit: 25000 },
            { id: 18, name: "–ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å", price: 50000000, profit: 250000 },
        ]
    };

    // --- –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ ---
    let gameState = {};

    // --- –≠–õ–ï–ú–ï–ù–¢–´ –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
    const chatContainer = document.getElementById('chat-container');
    const keyboardArea = document.getElementById('keyboard-area');

    // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
    function formatCurrency(n, c = '$') { return `üí∞ ${new Intl.NumberFormat('ru-RU').format(Math.round(n))}${c}`; }
    function formatBTC(n) { return `üíé ${(n || 0).toFixed(4)}‚Çø`; }
    function formatEuro(n) { return `üí∂ ${new Intl.NumberFormat('ru-RU').format(Math.round(n))}‚Ç¨`; }
    function formatTime(ms) { if (ms <= 0) return "0 —Å–µ–∫."; let s = Math.floor((ms / 1000) % 60), m = Math.floor((ms / 60000) % 60), h = Math.floor(ms / 3600000); return `${h} —á. ${m} –º–∏–Ω. ${s} —Å–µ–∫.`; }
    function formatFullDate(d) { return new Date(d).toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }
    function getDaysInGame(joinTimestamp) { return Math.floor((Date.now() - joinTimestamp) / 86400000); }
    function getXpForNextLevel(l) { return 4 + (4 * l); }
    function parseAmount(str) { let s = String(str).toLowerCase().trim().replace(/–∫/g, 'k'); let value = parseFloat(s.replace(/,/g, '')); if (s.endsWith('kk')) { value *= 1000000; } else if (s.endsWith('k')) { value *= 1000; } return isNaN(value) ? 0 : value; }

    // --- –°–û–•–†–ê–ù–ï–ù–ò–ï –î–ê–ù–ù–´–• –í FIRESTORE ---
    async function savePlayerState() {
        if (!db || !userId) return;
        try {
            const stateToSave = JSON.parse(JSON.stringify(gameState.player));
            const playerDocRef = doc(db, `/artifacts/${appId}/users/${userId}/gameData/player`);
            await setDoc(playerDocRef, stateToSave);
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞: ", error);
            addBotMessage('<p class="text-red-400">‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>');
        }
    }

    // --- –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ì–†–´ ---
    function addBotMessage(text, asHtml = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex justify-start items-start space-x-2';
        messageDiv.innerHTML = `
            <img class="w-8 h-8 rounded-full flex-shrink-0" src="https://placehold.co/100x100/1a202c/ffffff?text=B" alt="–ê–≤–∞—Ç–∞—Ä –ë–æ—Ç–∞">
            <div class="bg-gray-700 text-white p-3 rounded-xl rounded-tl-none chat-bubble">
                ${asHtml ? text : `<p>${text}</p>`}
            </div>
        `;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function addUserMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex justify-end items-start space-x-2';
        messageDiv.innerHTML = `
            <div class="bg-blue-600 text-white p-3 rounded-xl rounded-tr-none chat-bubble">
                <p>${text}</p>
            </div>
            <img class="w-8 h-8 rounded-full flex-shrink-0" src="${document.getElementById('bot-avatar').src}" alt="–ê–≤–∞—Ç–∞—Ä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        `;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function renderKeyboard(buttons = []) {
        keyboardArea.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        const gridDiv = document.createElement('div');
        gridDiv.className = 'keyboard-grid grid grid-cols-2 gap-2';

        if (buttons.length === 0) { // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            switch (gameState.currentMenu) {
                case 'main':
                    buttons = [
                        { label: '‚öôÔ∏è –ü—Ä–æ—Ñ–∏–ª—å', command: 'view_profile', isNav: true },
                        { label: 'üíº –†–∞–±–æ—Ç–∞', command: 'view_work', isNav: true },
                        { label: 'üè¶ –ë–∞–Ω–∫', command: 'view_bank', isNav: true },
                        { label: 'üìà –†—ã–Ω–æ–∫', command: 'view_market', isNav: true },
                        { label: 'üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω', command: 'view_shop', isNav: true },
                        { label: 'üéÅ –ë–æ–Ω—É—Å—ã', command: 'get_bonus' }
                    ];
                    break;
                case 'profile':
                    buttons = [
                        { label: 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', command: 'profile_stats' },
                        { label: '‚¨ÜÔ∏è –£—Ä–æ–≤–Ω–∏', command: 'profile_levels' },
                        { label: 'üè¢ –ë–∏–∑–Ω–µ—Å—ã', command: 'profile_businesses' },
                        { label: 'üì¶ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å', command: 'profile_inventory', isNav: true },
                        { label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back', isNav: true }
                    ];
                    break;
                case 'work':
                    buttons = [
                        { label: '–î–æ—Å—Ç–∞–≤–∫–∞ –ø–∏—Ü—Ü—ã (1-5–∫)', command: 'work_start 1' },
                        { label: '–ü–µ—Ä–µ–≤–æ–∑–∫–∞ –º–µ–±–µ–ª–∏ (30-50–∫)', command: 'work_start 2' },
                        { label: '–ö–æ–Ω—Ç—Ä–∞–±–∞–Ω–¥–∞ —á–∏–ø–æ–≤ (100-250–∫)', command: 'work_start 3' },
                        { label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back', isNav: true }
                    ];
                    break;
                case 'bank':
                    buttons = [
                        { label: '‚õèÔ∏è –ú–∞–π–Ω–∏–Ω–≥', command: 'view_mining', isNav: true },
                        { label: 'üí∞ –í–∫–ª–∞–¥—ã', command: 'view_deposits', isNav: true },
                        { label: 'üë¥ –ü–µ–Ω—Å–∏—è', command: 'bank_pension' },
                        { label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back', isNav: true }
                    ];
                    break;
                case 'mining':
                    const miningActive = gameState.player.mining && gameState.player.mining.active;
                    buttons = [
                        miningActive ? { label: 'üíé –ó–∞–±—Ä–∞—Ç—å BTC', command: 'mining_claim' } : { label: '‚õèÔ∏è –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ú–∞–π–Ω–∏–Ω–≥', command: 'mining_activate' },
                        { label: '‚¨ÜÔ∏è –£–ª—É—á—à–∏—Ç—å –ú–∞–π–Ω–µ—Ä', command: 'mining_upgrade_prompt' },
                        { label: 'üí≤ –ü—Ä–æ–¥–∞—Ç—å BTC', command: 'mining_sell_prompt' },
                        { label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back', isNav: true }
                    ];
                    break;
                case 'deposits':
                    buttons = [
                        { label: '‚ûï –û—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥', command: 'deposit_create_prompt' },
                        { label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back', isNav: true }
                    ];
                    break;
                case 'market':
                    buttons = [
                        { label: 'üè¢ –ö—É–ø–∏—Ç—å –±–∏–∑–Ω–µ—Å', command: 'market_businesses', isNav: true },
                        { label: 'üéÅ –ü—Ä–æ–º–æ–∫–æ–¥—ã', command: 'view_promo', isNav: true },
                        { label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back', isNav: true }
                    ];
                    break;
                case 'promo':
                    buttons = [
                        { label: '‚ûï –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥', command: 'promo_create_prompt' },
                        { label: 'üéÅ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥', command: 'promo_activate_prompt' },
                        { label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back', isNav: true }
                    ];
                    break;
                case 'inventory':
                    buttons = [];
                    if (gameState.player.inventory && gameState.player.inventory.length > 0) {
                        gameState.player.inventory.forEach(item => {
                            if (item.type === 'case') {
                                buttons.push({ label: `${item.icon} ${item.name} (${item.quantity})`, command: `item_manage ${item.id}`, isNav: true });
                            }
                        });
                    }
                    buttons.push({ label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back', isNav: true });
                    break;
                case 'item_management': // –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–æ–º
                    buttons = [
                        { label: '‚ûï –û—Ç–∫—Ä—ã—Ç—å 1', command: `case_open ${gameState.currentManagedItemId} 1` },
                        { label: '‚ûï –û—Ç–∫—Ä—ã—Ç—å 5', command: `case_open ${gameState.currentManagedItemId} 5` },
                        { label: '‚ûï –û—Ç–∫—Ä—ã—Ç—å 10', command: `case_open ${gameState.currentManagedItemId} 10` },
                        { label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'view_inventory', isNav: true }
                    ];
                    break;
                case 'shop': // –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞
                    for (const key in config.donationCases) {
                        const item = config.donationCases[key];
                        buttons.push({ label: `–ö—É–ø–∏—Ç—å ${item.name} (${item.price} –≥–æ–ª.)`, command: `shop_buy ${item.id}` });
                    }
                    buttons.push({ label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back', isNav: true });
                    break;
                case 'input': // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤–≤–æ–¥–∞
                    // –ó–¥–µ—Å—å –º—ã –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–º –∫–Ω–æ–ø–∫–∏, —Ç–∞–∫ –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç—Å—è –≤–≤–æ–¥
                    break;
            }
        }

        buttons.forEach(btn => {
            const button = document.createElement('button');
            button.className = 'bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-xl text-lg transition duration-200 ease-in-out';
            button.textContent = btn.label;
            button.onclick = () => window.sendCommand(btn.command, btn.label, btn.isNav); // –ü–µ—Ä–µ–¥–∞–µ–º label –∏ isNav
            gridDiv.appendChild(button);
        });

        keyboardArea.appendChild(gridDiv);

        // –ï—Å–ª–∏ –æ–∂–∏–¥–∞–µ—Ç—Å—è –≤–≤–æ–¥, –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
        if (gameState.prompt) {
            const inputGroup = document.createElement('div');
            inputGroup.className = 'mt-3 flex space-x-2';
            inputGroup.innerHTML = `
                <input type="text" id="text-input" placeholder="${gameState.prompt.placeholder || '–í–≤–µ–¥–∏—Ç–µ —á—Ç–æ-—Ç–æ...'}"
                       class="flex-1 bg-gray-700 text-white p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                       onkeydown="if(event.keyCode===13) window.submitInput()">
                <button onclick="window.submitInput()"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 ease-in-out">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            `;
            keyboardArea.appendChild(inputGroup);
            document.getElementById('text-input').focus();
        }
    }

    function renderInput(placeholder, prevView = null) {
        gameState.prompt = { placeholder, prevView };
        renderKeyboard([]); // –†–µ–Ω–¥–µ—Ä–∏–º –ø—É—Å—Ç—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–Ω–ø—É—Ç
    }

    function showView(viewName) {
        if (gameState.currentMenu !== viewName && !['input', 'prompt'].includes(viewName)) {
            gameState.menuHistory.push(gameState.currentMenu);
        }
        gameState.currentMenu = viewName;
        renderKeyboard();
    }

    function goBack() {
        if (gameState.menuHistory.length > 0) {
            const prevMenu = gameState.menuHistory.pop();
            gameState.currentMenu = prevMenu;
            renderKeyboard();
        } else {
            showView('main'); // –ï—Å–ª–∏ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        }
    }

    function backToMain() {
        gameState.menuHistory = []; // –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        showView('main');
    }

    async function startWork(contractId) {
        const contract = config.workContracts.find(c => c.id === contractId);
        if (!contract) { addBotMessage("<p>–¢–∞–∫–æ–π —Ä–∞–±–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>"); return; }

        const p = gameState.player;
        if (p.level < contract.requiredLevel) {
            addBotMessage(`<p>‚ùå –î–ª—è —ç—Ç–æ–π —Ä–∞–±–æ—Ç—ã –Ω—É–∂–µ–Ω —É—Ä–æ–≤–µ–Ω—å ${contract.requiredLevel}. –£ –≤–∞—Å ${p.level}.</p>`);
            return;
        }
        if (p.currentWork && p.currentWork.endTime > Date.now()) {
            addBotMessage("<p>‚ö†Ô∏è –í—ã —É–∂–µ –Ω–∞ —Ä–∞–±–æ—Ç–µ! –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.</p>");
            return;
        }

        p.currentWork = {
            contractId: contract.id,
            startTime: Date.now(),
            endTime: Date.now() + contract.duration * 1000 // Convert seconds to milliseconds
        };
        addBotMessage(`<p>‚úÖ –í—ã –ø—Ä–∏—Å—Ç—É–ø–∏–ª–∏ –∫ —Ä–∞–±–æ—Ç–µ "${contract.title}". –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${formatTime(contract.duration * 1000)}.</p>`);
        await savePlayerState();
        showView('work');
    }

    // –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, setInterval)
    async function gameTick() {
        const p = gameState.player;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã
        if (p.currentWork && p.currentWork.endTime <= Date.now()) {
            const contract = config.workContracts.find(c => c.id === p.currentWork.contractId);
            if (contract) {
                let reward = Math.floor(Math.random() * (contract.maxReward - contract.minReward + 1)) + contract.minReward;
                const riskFactor = Math.random();
                let message = `<p>‚úÖ –†–∞–±–æ—Ç–∞ "${contract.title}" –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ ${formatCurrency(reward)}.</p>`;
                if (riskFactor < contract.risk) {
                    reward = Math.floor(reward * 0.5); // –£–º–µ–Ω—å—à–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É –≤ —Å–ª—É—á–∞–µ —Ä–∏—Å–∫–∞
                    message = `<p class="text-yellow-400">‚ö†Ô∏è –†–∞–±–æ—Ç–∞ "${contract.title}" –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è–º–∏. –í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ ${formatCurrency(reward)} (–æ–±—ã—á–Ω–æ –±–æ–ª—å—à–µ).</p>`;
                }
                p.balance += reward;
                p.xp += 2; // –û–ø—ã—Ç –∑–∞ —Ä–∞–±–æ—Ç—É
                addBotMessage(message);
                checkLevelUp();
            }
            p.currentWork = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Ä–∞–±–æ—Ç—É
            await savePlayerState();
            showView('work'); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–π–Ω–∏–Ω–≥–∞
        if (p.mining && p.mining.active && p.mining.lastMined + p.mining.interval <= Date.now()) {
            p.bitcoin += p.mining.speed;
            p.mining.lastMined = Date.now();
            await savePlayerState();
            // addBotMessage(`<p>‚õèÔ∏è –í–∞—à –º–∞–π–Ω–µ—Ä –Ω–∞–º–∞–π–Ω–∏–ª ${formatBTC(p.mining.speed)}!</p>`); // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –º–∞–π–Ω–∏–Ω–≥–µ
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∫–ª–∞–¥–æ–≤
        for (let i = 0; i < p.deposits.length; i++) {
            const deposit = p.deposits[i];
            if (!deposit.claimed && deposit.payoutTime <= Date.now()) {
                const interest = deposit.amount * (deposit.rate / 100);
                const totalReturn = deposit.amount + interest;
                p.balance += totalReturn;
                deposit.claimed = true; // –û—Ç–º–µ—á–∞–µ–º –≤–∫–ª–∞–¥ –∫–∞–∫ –∑–∞–±—Ä–∞–Ω–Ω—ã–π
                addBotMessage(`<p>üè¶ –í–∞—à –≤–∫–ª–∞–¥ –Ω–∞ ${formatCurrency(deposit.amount)} —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω! –í—ã –ø–æ–ª—É—á–∏–ª–∏ ${formatCurrency(totalReturn)} (—á–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å ${formatCurrency(interest)}).</p>`);
                await savePlayerState();
            }
        }
        p.deposits = p.deposits.filter(d => !d.claimed); // –£–¥–∞–ª—è–µ–º –∑–∞–±—Ä–∞–Ω–Ω—ã–µ –≤–∫–ª–∞–¥—ã


        // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–∏–±—ã–ª–∏ –æ—Ç –±–∏–∑–Ω–µ—Å–æ–≤
        for (let i = 0; i < p.businesses.length; i++) {
            const business = p.businesses[i];
            const now = Date.now();
            const lastPayout = business.lastPayout || p.joinDate; // –ò—Å–ø–æ–ª—å–∑—É–µ–º joinDate –µ—Å–ª–∏ lastPayout –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

            if (now - lastPayout >= 3600000) { // –ï—Å–ª–∏ –ø—Ä–æ—à–µ–ª —á–∞—Å (3600000 –º—Å)
                const hoursPassed = Math.floor((now - lastPayout) / 3600000);
                const profitEarned = business.profit * hoursPassed;
                p.balance += profitEarned;
                business.lastPayout = lastPayout + (hoursPassed * 3600000); // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤—ã–ø–ª–∞—Ç—ã
                addBotMessage(`<p>üè¢ –ë–∏–∑–Ω–µ—Å "${business.name}" –ø—Ä–∏–Ω–µ—Å ${formatCurrency(profitEarned)} –∑–∞ ${hoursPassed} —á.</p>`);
                await savePlayerState();
            }
        }
    }


    function checkLevelUp() {
        const p = gameState.player;
        const xpForNext = getXpForNextLevel(p.level);
        if (p.xp >= xpForNext) {
            p.level++;
            p.xp -= xpForNext; // –û—Å—Ç–∞–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫ –æ–ø—ã—Ç–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
            p.balance += 100000 * p.level; // –ë–æ–Ω—É—Å –∑–∞ —É—Ä–æ–≤–µ–Ω—å
            p.businessSlots++; // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–ª–æ—Ç –±–∏–∑–Ω–µ—Å–∞
            addBotMessage(`<p class="text-green-400">üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ —É—Ä–æ–≤–Ω—è ${p.level}! –í—ã –ø–æ–ª—É—á–∏–ª–∏ ${formatCurrency(100000 * p.level)} –∏ –Ω–æ–≤—ã–π —Å–ª–æ—Ç –¥–ª—è –±–∏–∑–Ω–µ—Å–∞!</p>`);
            // –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ–ø—ã—Ç–∞ —Ö–≤–∞—Ç–∏–ª–æ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Ä–æ–≤–Ω–µ–π
            checkLevelUp();
        }
    }

    function showInitialProfile() {
        const p = gameState.player;
        const daysInGame = getDaysInGame(p.joinDate);
        addBotMessage(`
            <p><b>${p.name}, –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å:</b></p>
            <hr class="border-gray-600 my-1">
            <p>üí∞ –ë–∞–ª–∞–Ω—Å: ${formatCurrency(p.balance)}</p>
            <p>üíé Bitcoin: ${formatBTC(p.bitcoin)}</p>
            <p>üí∂ –ï–≤—Ä–æ: ${formatEuro(p.euro)}</p>
            <p>‚≠ê –£—Ä–æ–≤–µ–Ω—å: ${p.level} (–û–ø—ã—Ç: ${p.xp}/${getXpForNextLevel(p.level)})</p>
            <p>üíº –ë–∏–∑–Ω–µ—Å—ã: ${p.businesses.length}/${p.businessSlots}</p>
            <p>üìÖ –î–Ω–µ–π –≤ –∏–≥—Ä–µ: ${daysInGame}</p>
        `, true);
        showView('profile');
    }

    function showLevels() {
        const p = gameState.player;
        let msg = `<p><b>‚≠ê –í–∞—à–∞ –ø—Ä–æ–∫–∞—á–∫–∞:</b></p><hr class="border-gray-600 my-1">
                   <p>–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å: ${p.level}</p>
                   <p>–û–ø—ã—Ç: ${p.xp}/${getXpForNextLevel(p.level)}</p>
                   <p>–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å: ${p.level + 1}</p>`;
        addBotMessage(msg, true);
        showView('profile');
    }

    function showBusinesses() {
        const p = gameState.player;
        let msg = `<p><b>üè¢ –í–∞—à–∏ –±–∏–∑–Ω–µ—Å—ã (${p.businesses.length}/${p.businessSlots}):</b></p><hr class="border-gray-600 my-1">`;
        if (p.businesses.length === 0) {
            msg += "<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –±–∏–∑–Ω–µ—Å–æ–≤.</p>";
        } else {
            p.businesses.forEach(b => {
                msg += `<p>- ${b.name} (–ü—Ä–∏–±—ã–ª—å: ${formatCurrency(b.profit)}/—á.)</p>`;
            });
        }
        addBotMessage(msg, true);
        showView('profile');
    }

    function showMarketBusinesses() {
        let msg = '<p><b>üìà –ë–∏–∑–Ω–µ—Å—ã –Ω–∞ –ø—Ä–æ–¥–∞–∂—É:</b></p><hr class="border-gray-600 my-1">';
        const buttons = [];
        config.businessesForSale.forEach(b => {
            msg += `<p>üè¢ ${b.name}<br>–¶–µ–Ω–∞: ${formatCurrency(b.price)}<br>–ü—Ä–∏–±—ã–ª—å: ${formatCurrency(b.profit)}/—á.</p><hr class="border-gray-600 my-1">`;
            buttons.push({ label: `–ö—É–ø–∏—Ç—å "${b.name}"`, command: `biz_buy ${b.id}` });
        });
        buttons.push({ label: '‚Ü©Ô∏è –ù–∞–∑–∞–¥', command: 'back', isNav: true });
        addBotMessage(msg, true);
        renderKeyboard(buttons);
    }

    async function buyBusiness(businessId) {
        const business = config.businessesForSale.find(b => b.id === businessId);
        if (!business) { addBotMessage("<p>‚ùå –¢–∞–∫–æ–π –±–∏–∑–Ω–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>"); return; }

        const p = gameState.player;
        if (p.businesses.length >= p.businessSlots) {
            addBotMessage("<p>‚ùå –£ –≤–∞—Å –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞. –ü–æ–≤—ã—Å—å—Ç–µ —É—Ä–æ–≤–µ–Ω—å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –±–æ–ª—å—à–µ —Å–ª–æ—Ç–æ–≤.</p>");
            return;
        }
        if (p.balance < business.price) {
            addBotMessage("<p>‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ —ç—Ç–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞.</p>");
            return;
        }

        p.balance -= business.price;
        p.businesses.push({ ...business, lastPayout: Date.now() }); // –î–æ–±–∞–≤–ª—è–µ–º lastPayout –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ
        addBotMessage(`<p>‚úÖ –í—ã –∫—É–ø–∏–ª–∏ –±–∏–∑–Ω–µ—Å "${business.name}" –∑–∞ ${formatCurrency(business.price)}!</p>`);
        await savePlayerState();
        showView('market');
    }

    function activateMining() {
        const p = gameState.player;
        if (p.mining && p.mining.active) {
            addBotMessage("<p>‚õèÔ∏è –ú–∞–π–Ω–∏–Ω–≥ —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω!</p>");
            return;
        }
        p.mining = {
            active: true,
            lastMined: Date.now(),
            level: 1,
            speed: 0.0001, // –Ω–∞—á–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –¥–æ–±—ã—á–∏ BTC
            interval: 10000 // 10 —Å–µ–∫—É–Ω–¥ –Ω–∞ 0.0001 BTC
        };
        addBotMessage("<p>‚õèÔ∏è –ú–∞–π–Ω–∏–Ω–≥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –í—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å 0.0001 BTC –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥.</p>");
        savePlayerState();
        showView('mining');
    }

    async function upgradeMiningPrompt() {
        const p = gameState.player;
        const upgradeCost = (p.mining ? p.mining.level : 0) * 500000 + 100000; // –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏—è
        if (p.balance < upgradeCost) {
            addBotMessage(`<p>‚ùå –î–ª—è —É–ª—É—á—à–µ–Ω–∏—è –º–∞–π–Ω–µ—Ä–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è ${formatCurrency(upgradeCost)}. –£ –≤–∞—Å ${formatCurrency(p.balance)}.</p>`);
            showView('mining');
            return;
        }
        renderInput(`–í–≤–µ–¥–∏—Ç–µ "–¥–∞", —á—Ç–æ–±—ã —É–ª—É—á—à–∏—Ç—å –º–∞–π–Ω–µ—Ä –∑–∞ ${formatCurrency(upgradeCost)}:`, 'mining_upgrade_execute');
    }

    async function upgradeMiningExecute(input) {
        if (input.toLowerCase() !== '–¥–∞') {
            addBotMessage("<p>–û—Ç–º–µ–Ω–∞ —É–ª—É—á—à–µ–Ω–∏—è –º–∞–π–Ω–µ—Ä–∞.</p>");
            showView('mining');
            return;
        }
        const p = gameState.player;
        const upgradeCost = (p.mining ? p.mining.level : 0) * 500000 + 100000;
        if (p.balance < upgradeCost) { // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
            addBotMessage("<p>‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –º–∞–π–Ω–µ—Ä–∞.</p>");
            showView('mining');
            return;
        }
        p.balance -= upgradeCost;
        p.mining.level++;
        p.mining.speed += 0.0001; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –¥–æ–±—ã—á–∏
        p.mining.interval = Math.max(1000, p.mining.interval - 1000); // –£–º–µ–Ω—å—à–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª, –Ω–æ –Ω–µ –Ω–∏–∂–µ 1 —Å–µ–∫—É–Ω–¥—ã
        addBotMessage(`<p>‚úÖ –í–∞—à –º–∞–π–Ω–µ—Ä —É–ª—É—á—à–µ–Ω –¥–æ —É—Ä–æ–≤–Ω—è ${p.mining.level}! –°–∫–æ—Ä–æ—Å—Ç—å: ${formatBTC(p.mining.speed)} –∫–∞–∂–¥—ã–µ ${p.mining.interval / 1000} —Å–µ–∫.</p>`);
        await savePlayerState();
        showView('mining');
    }

    async function claimMinedBtc() {
        const p = gameState.player;
        if (!p.mining || !p.mining.active || p.bitcoin === 0) {
            addBotMessage("<p>‚ùå –£ –≤–∞—Å –Ω–µ—Ç –Ω–∞–º–∞–π–Ω–µ–Ω–Ω—ã—Ö BTC –¥–ª—è –≤—ã–≤–æ–¥–∞.</p>");
            return;
        }
        const amount = p.bitcoin;
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º 50,000,000 –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫—É—Ä—Å–∞ BTC –∫ USD, –∫–∞–∫ –±—ã–ª–æ —É–∫–∞–∑–∞–Ω–æ —Ä–∞–Ω–µ–µ
        const btcToUsdRate = 50000000;
        p.balance += amount * btcToUsdRate;
        p.bitcoin = 0;
        addBotMessage(`<p>‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–¥–∞–ª–∏ ${formatBTC(amount)} –∑–∞ ${formatCurrency(amount * btcToUsdRate)}!</p>`);
        await savePlayerState();
        showView('mining');
    }

    async function sellBtcPrompt() {
        const p = gameState.player;
        if (p.bitcoin === 0) {
            addBotMessage("<p>‚ùå –£ –≤–∞—Å –Ω–µ—Ç BTC –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏.</p>");
            showView('mining');
            return;
        }
        renderInput(`–°–∫–æ–ª—å–∫–æ BTC –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–∞—Ç—å? (–£ –≤–∞—Å ${formatBTC(p.bitcoin)})`, 'sell_btc_execute');
    }

    async function sellBtcExecute(input) {
        const amount = parseFloat(input);
        const p = gameState.player;
        if (isNaN(amount) || amount <= 0 || amount > p.bitcoin) {
            addBotMessage("<p>‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ BTC –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏.</p>");
            showView('mining');
            return;
        }
        p.bitcoin -= amount;
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º 50,000,000 –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫—É—Ä—Å–∞ BTC –∫ USD
        const btcToUsdRate = 50000000;
        p.balance += amount * btcToUsdRate;
        addBotMessage(`<p>‚úÖ –í—ã –ø—Ä–æ–¥–∞–ª–∏ ${formatBTC(amount)} –∑–∞ ${formatCurrency(amount * btcToUsdRate)}!</p>`);
        await savePlayerState();
        showView('mining');
    }

    async function claimPension() {
        const p = gameState.player;
        const daysInGame = getDaysInGame(p.joinDate);
        // –ü–µ–Ω—Å–∏—è —Ä–∞–∑ –≤ 7 –¥–Ω–µ–π
        const nextPensionTime = (p.lastPensionClaim || p.joinDate) + (7 * 24 * 60 * 60 * 1000);
        if (Date.now() < nextPensionTime) {
            const timeLeft = nextPensionTime - Date.now();
            addBotMessage(`<p>‚è≥ –í—ã —Å–º–æ–∂–µ—Ç–µ –∑–∞–±—Ä–∞—Ç—å –ø–µ–Ω—Å–∏—é —á–µ—Ä–µ–∑ ${formatTime(timeLeft)}.</p>`);
            return;
        }
        const pensionAmount = p.level * 10000; // –ü—Ä–∏–º–µ—Ä: 10000$ –∑–∞ –∫–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å
        p.balance += pensionAmount;
        p.lastPensionClaim = Date.now();
        addBotMessage(`<p>üë¥ –í—ã –ø–æ–ª—É—á–∏–ª–∏ –ø–µ–Ω—Å–∏—é –≤ —Ä–∞–∑–º–µ—Ä–µ ${formatCurrency(pensionAmount)}!</p>`);
        await savePlayerState();
        showView('bank');
    }

    async function claimBonus() {
        const p = gameState.player;
        const now = Date.now();
        const todayStart = new Date().setHours(0, 0, 0, 0); // –ù–∞—á–∞–ª–æ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –±–æ–Ω—É—Å —É–∂–µ –∑–∞–±—Ä–∞–Ω —Å–µ–≥–æ–¥–Ω—è
        if (p.lastBonusClaim && new Date(p.lastBonusClaim).setHours(0, 0, 0, 0) === todayStart) {
            addBotMessage("<p>‚ùå –í—ã —É–∂–µ –ø–æ–ª—É—á–∏–ª–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å —Å–µ–≥–æ–¥–Ω—è. –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –∑–∞–≤—Ç—Ä–∞!</p>");
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ —Å–µ—Ä–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–∞ (–µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –±–æ–Ω—É—Å –±—ã–ª –Ω–µ –≤—á–µ—Ä–∞)
        if (p.lastBonusClaim && new Date(p.lastBonusClaim).setHours(0, 0, 0, 0) !== (todayStart - 24 * 60 * 60 * 1000)) {
            p.bonusStreak = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–µ—Ä–∏—é, –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ –≤—á–µ—Ä–∞—à–Ω–µ–≥–æ –±–æ–Ω—É—Å–∞
        }

        p.bonusStreak = (p.bonusStreak || 0) + 1; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–µ—Ä–∏—é
        const bonusAmount = 10000 + (p.bonusStreak - 1) * 5000; // –ë–∞–∑–æ–≤—ã–π + –∑–∞ —Å–µ—Ä–∏—é
        p.balance += bonusAmount;
        p.lastBonusClaim = now; // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±–æ–Ω—É—Å–∞

        addBotMessage(`<p>üéÅ –í—ã –ø–æ–ª—É—á–∏–ª–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å: ${formatCurrency(bonusAmount)}! –°–µ—Ä–∏—è: ${p.bonusStreak} –¥–Ω–µ–π.</p>`);
        await savePlayerState();
        showView('main');
    }


    async function createDepositPrompt() {
        renderInput("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –≤–∫–ª–∞–¥–∞ (–º–∏–Ω. 10000, –º–∞–∫—Å. 100000000):", 'create_deposit_execute');
    }

    async function createDeposit(amountStr) {
        const amount = parseAmount(amountStr);
        const p = gameState.player;

        if (isNaN(amount) || amount < 10000 || amount > 100000000) {
            addBotMessage("<p>‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è –≤–∫–ª–∞–¥–∞. –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 10000 –¥–æ 100000000.</p>");
            showView('deposits');
            return;
        }
        if (p.balance < amount) {
            addBotMessage("<p>‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∫–ª–∞–¥–∞.</p>");
            showView('deposits');
            return;
        }

        const durationDays = 7; // –ü—Ä–∏–º–µ—Ä: –≤–∫–ª–∞–¥ –Ω–∞ 7 –¥–Ω–µ–π
        const rate = 0.05; // 5% –≥–æ–¥–æ–≤—ã—Ö, –¥–ª—è 7 –¥–Ω–µ–π –±—É–¥–µ—Ç –º–µ–Ω—å—à–µ

        p.balance -= amount;
        p.deposits.push({
            amount: amount,
            startTime: Date.now(),
            payoutTime: Date.now() + (durationDays * 24 * 60 * 60 * 1000),
            rate: rate,
            claimed: false
        });
        addBotMessage(`<p>‚úÖ –í—ã –æ—Ç–∫—Ä—ã–ª–∏ –≤–∫–ª–∞–¥ –Ω–∞ ${formatCurrency(amount)} –ø–æ–¥ ${rate * 100}% –≥–æ–¥–æ–≤—ã—Ö. –í—ã–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ ${durationDays} –¥–Ω–µ–π.</p>`);
        await savePlayerState();
        showView('deposits');
    }

    function showInventory() {
        const p = gameState.player;
        let msg = `<p><b>üì¶ –í–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å:</b></p><hr class="border-gray-600 my-1">`;
        if (!p.inventory || p.inventory.length === 0) {
            msg += "<p>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç.</p>";
        } else {
            p.inventory.forEach(item => {
                msg += `<p>${item.icon} ${item.name} (${item.quantity})</p>`;
            });
        }
        addBotMessage(msg, true);
        showView('inventory');
    }

    async function showItemManagement(itemId) {
        const item = gameState.player.inventory.find(i => i.id === itemId);
        if (!item) {
            addBotMessage("<p>‚ùå –ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ.</p>");
            showView('inventory');
            return;
        }
        gameState.currentManagedItemId = itemId; // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —É–ø—Ä–∞–≤–ª—è–µ–º–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞
        addBotMessage(`<p><b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–º:</b> ${item.name} (–ö–æ–ª-–≤–æ: ${item.quantity})</p>`, true);
        showView('item_management');
    }

    async function openCase(caseId, count) {
        const p = gameState.player;
        const caseItem = p.inventory.find(item => item.id === caseId && item.type === 'case');
        const numToOpen = parseInt(count);

        if (!caseItem || caseItem.quantity < numToOpen || numToOpen <= 0) {
            addBotMessage("<p>‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–µ–π—Å–æ–≤ –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è.</p>");
            showView('item_management');
            return;
        }

        const caseConfig = config.cases[caseId];
        if (!caseConfig) {
            addBotMessage("<p>‚ùå –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–µ–π—Å–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.</p>");
            showView('item_management');
            return;
        }

        let totalLoot = 0;
        for (let i = 0; i < numToOpen; i++) {
            // FIX: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–ø–µ—á–∞—Ç–∫–∞ 'possibleLoot' –Ω–∞ 'caseConfig.possibleLoot'
            const loot = caseConfig.possibleLoot[Math.floor(Math.random() * caseConfig.possibleLoot.length)];
            totalLoot += loot;
        }

        p.balance += totalLoot;
        caseItem.quantity -= numToOpen;

        if (caseItem.quantity <= 0) {
            p.inventory = p.inventory.filter(item => item.id !== caseId);
        }

        addBotMessage(`<p>‚úÖ –í—ã –æ—Ç–∫—Ä—ã–ª–∏ ${numToOpen} "${caseConfig.name}" –∏ –ø–æ–ª—É—á–∏–ª–∏ ${formatCurrency(totalLoot)}!</p>`);
        await savePlayerState();
        showView('inventory'); // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è
    }

    function showShop() {
        let msg = '<p><b>üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω:</b></p><hr class="border-gray-600 my-1">';
        for (const key in config.donationCases) {
            const item = config.donationCases[key];
            msg += `<p>${item.icon} <b>${item.name}</b><br>–¶–µ–Ω–∞: ${item.price} –≥–æ–ª–æ—Å–æ–≤ VK</p>`;
            if (item.content.balance) msg += `<p>   –ù–∞–≥—Ä–∞–¥–∞: ${formatCurrency(item.content.balance)}</p>`;
            if (item.content.bitcoin) msg += `<p>   –ù–∞–≥—Ä–∞–¥–∞: ${formatBTC(item.content.bitcoin)}</p>`;
            if (item.content.euro) msg += `<p>   –ù–∞–≥—Ä–∞–¥–∞: ${formatEuro(item.content.euro)}</p>`;
            if (item.content.items && item.content.items.length > 0) {
                item.content.items.forEach(cItem => {
                    msg += `<p>   –ù–∞–≥—Ä–∞–¥–∞: ${cItem.quantity}x ${cItem.icon} ${cItem.name}</p>`;
                });
            }
            msg += `<hr class="border-gray-600 my-1">`;
        }
        addBotMessage(msg, true);
        showView('shop');
    }

    async function initiatePayment(productId) {
        const product = config.donationCases[productId];
        if (!product) {
            addBotMessage("<p>‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>");
            return;
        }

        try {
            const response = await vkBridge.send('VKWebAppOpenPayForm', {
                app_id: appId,
                action: 'pay-to-group',
                params: {
                    amount: product.price,
                    description: product.name,
                    data: JSON.stringify({ userId: userId, productId: productId }) // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                }
            });

            if (response.status === 'success') {
                addBotMessage(`<p>‚úÖ –û–ø–ª–∞—Ç–∞ –∑–∞ "${product.name}" —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞!</p>`);
                // –ù–∞—á–∏—Å–ª—è–µ–º –Ω–∞–≥—Ä–∞–¥—ã –∏–≥—Ä–æ–∫—É
                const p = gameState.player;
                if (product.content.balance) p.balance += product.content.balance;
                if (product.content.bitcoin) p.bitcoin += product.content.bitcoin;
                if (product.content.euro) p.euro += product.content.euro;

                if (product.content.items) {
                    product.content.items.forEach(newItem => {
                        // –ó–¥–µ—Å—å –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è addItemToInventory, –∫–æ—Ç–æ—Ä–∞—è —Ç–µ–ø–µ—Ä—å –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–∞
                        addItemToInventory(newItem);
                    });
                }
                await savePlayerState();
            } else {
                addBotMessage("<p>‚ùå –û–ø–ª–∞—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –∏–ª–∏ –Ω–µ —É–¥–∞–ª–∞—Å—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.</p>");
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ VK Pay:", error);
            addBotMessage("<p class='text-red-400'>‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.</p>");
        }
        showView('shop');
    }

    async function createPromoPrompt() {
        renderInput("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤–∞–ª—é—Ç—ã –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ (–ù–∞–ø—Ä–∏–º–µ—Ä: 100000):", 'promo_currency_create');
    }

    async function createPromoCurrency(amountStr) {
        const amount = parseAmount(amountStr);
        const p = gameState.player;

        if (isNaN(amount) || amount <= 0) {
            addBotMessage("<p>‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞.</p>");
            showView('promo');
            return;
        }
        if (p.balance < amount * 2) { // –°—Ç–æ–∏–º–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, 2x –æ—Ç —Å—É–º–º—ã
            addBotMessage("<p>‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–∫–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞ (—Å—Ç–æ–∏–º–æ—Å—Ç—å: " + formatCurrency(amount * 2) + ").</p>");
            showView('promo');
            return;
        }

        const promoCode = Math.random().toString(36).substring(2, 8).toUpperCase(); // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –∫–æ–¥
        p.balance -= amount * 2;

        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã –¥–æ–ª–∂–Ω—ã —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        // –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ —Ö—Ä–∞–Ω–∏–º –∏—Ö –≤ gameState (–Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –ø—Ä–æ–¥)
        if (!gameState.promocodes) gameState.promocodes = {};
        gameState.promocodes[promoCode] = { type: 'currency', value: amount, usedBy: [] };

        addBotMessage(`<p>‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ "${promoCode}" –Ω–∞ ${formatCurrency(amount)} —Å–æ–∑–¥–∞–Ω! –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∏–º.</p>`);
        await savePlayerState();
        showView('promo');
    }

    async function activatePromoPrompt() {
        renderInput("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥:", 'promo_activate_execute');
    }

    async function activatePromoExecute(promoCode) {
        promoCode = promoCode.toUpperCase();
        const p = gameState.player;

        if (!gameState.promocodes || !gameState.promocodes[promoCode]) {
            addBotMessage("<p>‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>");
            showView('promo');
            return;
        }

        const promo = gameState.promocodes[promoCode];
        if (promo.usedBy.includes(userId)) {
            addBotMessage("<p>‚ùå –í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥.</p>");
            showView('promo');
            return;
        }

        if (promo.type === 'currency') {
            p.balance += promo.value;
            addBotMessage(`<p>‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ "${promoCode}" –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –í—ã –ø–æ–ª—É—á–∏–ª–∏ ${formatCurrency(promo.value)}.</p>`);
        }
        // –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –∑–¥–µ—Å—å (–∫–µ–π—Å—ã, BTC –∏ —Ç.–¥.)

        promo.usedBy.push(userId); // –û—Ç–º–µ—á–∞–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –ø—Ä–æ–º–æ–∫–æ–¥
        await savePlayerState();
        showView('promo');
    }

    function manageBusiness(businessId) {
        addBotMessage(`<p>–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å–æ–º (ID: ${businessId}) –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –°–∫–æ—Ä–æ –±—É–¥–µ—Ç!</p>`);
        showView('profile_businesses'); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É –±–∏–∑–Ω–µ—Å–æ–≤
    }

    // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–û–ú–ê–ù–î ---
    window.sendCommand = async (command, label = '', isNavCommand = false) => {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ-–Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
        if (!isNavCommand) {
            addUserMessage(label);
        }

        // –û—á–∏—â–∞–µ–º prompt, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫–æ–º–∞–Ω–¥–∞ submit_input
        if (gameState.prompt && command.split(' ')[0] !== 'submit_input') {
            gameState.prompt = null;
        }

        const [cmd, ...args] = command.split(' ');

        // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ "–¥—É–º–∞—é—â–µ–≥–æ" –±–æ—Ç–∞
        setTimeout(async () => {
            const commandHandlers = {
                'view_profile': showInitialProfile,
                'view_work': () => { addBotMessage("<p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É:</p>"); showView('work'); },
                'view_bank': () => { addBotMessage("<p>–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫–æ–≤—Å–∫—É—é –æ–ø–µ—Ä–∞—Ü–∏—é:</p>"); showView('bank'); },
                'view_market': () => { addBotMessage("<p>–ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –Ω–∞ —Ä—ã–Ω–∫–µ?</p>"); showView('market'); },
                'view_shop': showShop,
                'get_bonus': claimBonus,
                'profile_stats': showInitialProfile,
                'profile_levels': showLevels,
                'profile_businesses': showBusinesses,
                'profile_inventory': showInventory,
                'view_mining': () => { addBotMessage("<p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞–π–Ω–∏–Ω–≥–æ–º:</p>"); showView('mining'); },
                'view_deposits': () => { addBotMessage("<p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∞–º–∏:</p>"); showView('deposits'); },
                'bank_pension': claimPension,
                'market_businesses': showMarketBusinesses,
                'view_promo': () => { addBotMessage("<p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏:</p>"); showView('promo'); },
                'back': goBack,
                'back_to_main': backToMain,

                'work_start': () => startWork(parseInt(args[0])),
                'mining_activate': activateMining,
                'mining_upgrade_prompt': upgradeMiningPrompt,
                'mining_claim': claimMinedBtc,
                'mining_sell_prompt': sellBtcPrompt,
                'deposit_create_prompt': createDepositPrompt,
                'shop_buy': () => initiatePayment(args[0]),

                // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞
                'create_deposit_execute': createDeposit, // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
                'sell_btc_execute': sellBtcExecute,
                'mining_upgrade_execute': upgradeMiningExecute,
                'promo_currency_create': createPromoCurrency,
                'promo_activate_execute': activatePromoExecute,

                // --- –ö–û–ú–ê–ù–î–´ –ò–ó –í–ê–®–ï–ì–û –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–ì–û –ö–û–î–ê ---
                'company_fire': () => { addBotMessage('<p>–í—ã —É–≤–æ–ª–∏–ª–∏—Å—å.</p>'); gameState.company = null; savePlayerState(); showView('company'); },
                'company_join_execute': (companyId) => { addBotMessage(`<p>–ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–ø–∞–Ω–∏–∏ ${companyId}. (–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)</p>`); showView('company'); }, // –ó–∞–≥–ª—É—à–∫–∞
                'biz_manage': () => manageBusiness(parseInt(args[0])),
                'biz_buy': () => buyBusiness(parseInt(args[0])),
                'item_manage': () => showItemManagement(args[0]),
                'case_open': () => openCase(args[0], args[1]),
            };

            if (cmd === 'submit_input') {
                const input = document.getElementById('text-input').value;
                if (!input.trim()) return; // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π –≤–≤–æ–¥

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π callback –≤—ã–∑—ã–≤–∞—Ç—å, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –∑–∞–ø—Ä–æ—Å–µ
                if (gameState.prompt && typeof commandHandlers[gameState.prompt.prevView] === 'function') {
                    const callbackFunction = commandHandlers[gameState.prompt.prevView];
                    gameState.prompt = null; // –û—á–∏—â–∞–µ–º prompt –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º
                    await callbackFunction(input); // –ü–µ—Ä–µ–¥–∞–µ–º –≤–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ —Ñ—É–Ω–∫—Ü–∏—é
                } else {
                    addBotMessage("<p>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≤–≤–æ–¥ –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.</p>");
                }
                renderKeyboard(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞
                return; // –í—ã—Ö–æ–¥–∏–º, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
            }

            if (commandHandlers[cmd]) {
                await commandHandlers[cmd](...args); // –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏
            } else if (!isNavCommand && label && typeof label === 'string' && label !== 'undefined') {
                addBotMessage(`<p>–†–∞–∑–¥–µ–ª ¬´${label}¬ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</p>`);
            }
        }, 300);
    };

    window.submitInput = () => {
        window.sendCommand('submit_input', '–û—Ç–ø—Ä–∞–≤–∫–∞ –≤–≤–æ–¥–∞'); // –ü–µ—Ä–µ–¥–∞–µ–º –∫–æ–º–∞–Ω–¥—É 'submit_input'
    };


    // –ü—Ä–∏–≤—è–∑–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π –∫ window –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ HTML –∏ –¥—Ä—É–≥–∏—Ö —á–∞—Å—Ç–µ–π –∫–æ–¥–∞
    window.formatCurrency = formatCurrency;
    window.formatBTC = formatBTC;
    window.formatEuro = formatEuro;
    window.formatTime = formatTime;
    window.formatFullDate = formatFullDate;
    window.getDaysInGame = getDaysInGame;
    window.getXpForNextLevel = getXpForNextLevel;
    window.parseAmount = parseAmount;
    window.addBotMessage = addBotMessage;
    window.addUserMessage = addUserMessage;
    window.renderKeyboard = renderKeyboard;
    window.renderInput = renderInput;
    window.showView = showView;
    window.goBack = goBack;
    window.backToMain = backToMain;
    window.savePlayerState = savePlayerState;
    window.startWork = startWork;
    window.gameTick = gameTick;
    window.checkLevelUp = checkLevelUp;
    window.showInitialProfile = showInitialProfile;
    window.showLevels = showLevels;
    window.showBusinesses = showBusinesses;
    window.showMarketBusinesses = showMarketBusinesses;
    window.buyBusiness = buyBusiness;
    window.activateMining = activateMining;
    window.upgradeMiningPrompt = upgradeMiningPrompt;
    window.upgradeMiningExecute = upgradeMiningExecute;
    window.claimMinedBtc = claimMinedBtc;
    window.sellBtcPrompt = sellBtcPrompt;
    window.claimPension = claimPension;
    window.claimBonus = claimBonus;
    window.createDepositPrompt = createDepositPrompt;
    window.createDeposit = createDeposit;
    window.showInventory = showInventory;
    window.showItemManagement = showItemManagement;
    window.openCase = openCase;
    window.showShop = showShop;
    window.initiatePayment = initiatePayment;
    window.addItemToInventory = addItemToInventory; // ***–î–û–ë–ê–í–õ–ï–ù–û: –¢–µ–ø–µ—Ä—å addItemToInventory –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–∞***
    window.createPromoPrompt = createPromoPrompt;
    window.createPromoCurrency = createPromoCurrency;
    window.activatePromoPrompt = activatePromoPrompt;
    window.activatePromoExecute = activatePromoExecute;
    window.manageBusiness = manageBusiness;

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã ---
    document.addEventListener('DOMContentLoaded', async () => {
        console.clear(); // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Å–æ–ª—å –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const firebaseApp = initializeApp(firebaseConfig);
        auth = getAuth(firebaseApp);
        db = getFirestore(firebaseApp);

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ Firebase
        await setPersistence(auth, browserLocalPersistence);

        let user;
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ __initial_auth_token –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ, –∏–Ω–∞—á–µ –∞–Ω–æ–Ω–∏–º–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token && __initial_auth_token !== '') {
                await signInWithCustomToken(auth, __initial_auth_token);
                user = auth.currentUser; // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
            } else {
                user = await signInAnonymously(auth); // –ê–Ω–æ–Ω–∏–º–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
            }
            userId = user.uid;
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Firebase:", error);
            addBotMessage('<p class="text-red-400">‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase.</p>');
            loadingScreen.style.display = 'none';
            appContainer.style.display = 'flex';
            return;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞
        const playerDocRef = doc(db, `/artifacts/${appId}/users/${userId}/gameData/player`);
        const playerDocSnap = await getDoc(playerDocRef);

        if (playerDocSnap.exists()) {
            gameState.player = playerDocSnap.data();
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ –Ω–æ–≤—ã–µ –ø–æ–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã, –µ—Å–ª–∏ –æ–Ω–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ —Å—Ç–∞—Ä—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è—Ö
            if (typeof gameState.player.bitcoin === 'undefined') gameState.player.bitcoin = 0;
            if (typeof gameState.player.euro === 'undefined') gameState.player.euro = 0;
            if (typeof gameState.player.mining === 'undefined') gameState.player.mining = { active: false, level: 0, speed: 0, interval: 0, lastMined: 0 };
            if (typeof gameState.player.deposits === 'undefined') gameState.player.deposits = [];
            if (typeof gameState.player.lastPensionClaim === 'undefined') gameState.player.lastPensionClaim = 0;
            if (typeof gameState.player.lastBonusClaim === 'undefined') gameState.player.lastBonusClaim = 0;
            if (typeof gameState.player.bonusStreak === 'undefined') gameState.player.bonusStreak = 0; // –î–æ–±–∞–≤–ª—è–µ–º bonusStreak
            if (typeof gameState.player.businessSlots === 'undefined') gameState.player.businessSlots = 1;
            if (typeof gameState.player.businesses === 'undefined') gameState.player.businesses = [];
            if (typeof gameState.player.inventory === 'undefined') gameState.player.inventory = [];
            if (typeof gameState.promocodes === 'undefined') gameState.promocodes = {}; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—ä–µ–∫—Ç—ã Date –¥–ª—è lastPayout –≤ –±–∏–∑–Ω–µ—Å–∞—Ö
            gameState.player.businesses.forEach(b => {
                if (b.lastPayout && typeof b.lastPayout.toDate === 'function') {
                    b.lastPayout = b.lastPayout.toDate().getTime(); // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Timestamp –≤ —á–∏—Å–ª–æ
                }
            });

            // –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ joinDate –∏–∑ Timestamp –≤ —á–∏—Å–ª–æ (–µ—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∫–∞–∫ Timestamp)
            if (gameState.player.joinDate && typeof gameState.player.joinDate.toDate === 'function') {
                gameState.player.joinDate = gameState.player.joinDate.toDate().getTime();
            }
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Date –¥–ª—è lastMined –≤ mining
            if (gameState.player.mining && gameState.player.mining.lastMined && typeof gameState.player.mining.lastMined.toDate === 'function') {
                gameState.player.mining.lastMined = gameState.player.mining.lastMined.toDate().getTime();
            }
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Date –¥–ª—è deposits
            gameState.player.deposits.forEach(dep => {
                if (dep.payoutTime && typeof dep.payoutTime.toDate === 'function') {
                    dep.payoutTime = dep.payoutTime.toDate().getTime();
                }
                if (dep.createdAt && typeof dep.createdAt.toDate === 'function') {
                    dep.createdAt = dep.createdAt.toDate().getTime();
                }
            });


        } else {
            // –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫
            const userInfo = await vkBridge.send('VKWebAppGetUserInfo');
            gameState.player = {
                name: userInfo.first_name || '–ò–≥—Ä–æ–∫', // –ò—Å–ø–æ–ª—å–∑—É–µ–º '–ò–≥—Ä–æ–∫' –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
                balance: 10000,
                xp: 0,
                level: 1,
                bitcoin: 0,
                euro: 0,
                mining: { active: false, level: 0, speed: 0, interval: 0, lastMined: 0 },
                deposits: [],
                lastPensionClaim: 0,
                lastBonusClaim: 0,
                bonusStreak: 0, // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–∏–∏ –±–æ–Ω—É—Å–æ–≤
                joinDate: Date.now(),
                businessSlots: 1,
                businesses: [],
                inventory: []
            };
            gameState.promocodes = {}; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            await savePlayerState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        }

        // –û–±—â–∏–µ –∏–≥—Ä–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        gameState.currentMenu = 'main';
        gameState.menuHistory = [];
        gameState.exchangeRates = { btcToUsd: 50000000, usdToEur: 0.92 }; // –ü—Ä–∏–º–µ—Ä–Ω—ã–µ –∫—É—Ä—Å—ã

        loadingScreen.style.display = 'none';
        appContainer.style.display = 'flex';

        addBotMessage('<p>üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</p>');
        showView('main');
        setInterval(gameTick, 1000); // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä–æ–≤–æ–π —Ç–∏–∫ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    });
</script>

</body>
</html>
